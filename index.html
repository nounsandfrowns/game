<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Word Randomizer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .hidden { display: none !important; }
    body { 
      margin: 0; 
      padding: 0; 
      font-family: 'Montserrat', sans-serif;
    }
    #canvas { 
      touch-action: none; 
      cursor: crosshair;
      border: 2px solid #4E5987;
    }
  </style>
</head>
<body style="background-color: #D4E4DD;" class="min-h-screen p-4 md:p-8">
  <div class="max-w-6xl mx-auto" id="app">
    <div class="flex justify-end mb-2">
      <button onclick="toggleLandingHelp()" class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold hover:opacity-80" style="background-color: #4E5987;" title="Help">?</button>
    </div>
    <h1 class="text-3xl md:text-4xl font-bold text-center mb-2" style="color: #4E5987;">Word Randomizer</h1>
    <p class="text-center text-gray-600 text-sm mb-8">For games with friends for fun</p>

    <!-- Lobby -->
    <div id="lobby">
      <div class="grid md:grid-cols-2 gap-6">
        <div class="rounded-lg shadow-md p-4 md:p-6" style="background-color: #F5E6D3;">
          <h2 class="text-xl md:text-2xl font-bold mb-4" style="color: #4E5987;">Create Room</h2>
          <input type="text" id="createPlayerName" placeholder="Your name" class="w-full px-4 py-2 mb-3 border rounded-lg" maxlength="20">
          <input type="password" id="createPassword" placeholder="Set password (min 4 chars)" class="w-full px-4 py-2 mb-4 border rounded-lg" minlength="4">
          <button onclick="createRoom()" class="w-full px-6 py-3 text-white rounded-lg font-semibold hover:opacity-90" style="background-color: #1EA7D8;">Create Room</button>
        </div>
        <div class="rounded-lg shadow-md p-4 md:p-6" style="background-color: #F5E6D3;">
          <h2 class="text-xl md:text-2xl font-bold mb-4" style="color: #4E5987;">Join Room</h2>
          <input type="text" id="joinPlayerName" placeholder="Your name" class="w-full px-4 py-2 mb-3 border rounded-lg" maxlength="20">
          <input type="text" id="joinRoomCode" placeholder="4-digit room code" class="w-full px-4 py-2 mb-3 border rounded-lg" maxlength="4">
          <input type="password" id="joinPassword" placeholder="Room password" class="w-full px-4 py-2 mb-4 border rounded-lg">
          <button onclick="joinRoom()" class="w-full px-6 py-3 text-white rounded-lg font-semibold hover:opacity-90" style="background-color: #E85987;">Join Room</button>
        </div>
      </div>

      <!-- Banner Section -->
      <div id="lobbyBanner" class="mt-8 rounded-lg overflow-hidden shadow-md">
        <img id="bannerImage" src="" alt="Banner" class="w-full h-auto" style="display: none;">
        <div id="bannerPlaceholder" class="w-full py-16 text-center rounded-lg" style="background-color: #E8F4D0;">
          <p class="text-2xl font-semibold" style="color: #4E5987;">Your Banner Here</p>
        </div>
      </div>
    </div>

    <!-- Game Room -->
    <div id="gameRoom" class="hidden">
      <div class="rounded-lg shadow-md p-4 md:p-6 mb-6" style="background-color: #F5E6D3;">
        <div class="flex flex-col md:flex-row justify-between md:items-center gap-2">
          <div>
            <h2 class="text-lg md:text-xl font-semibold">Room: <span id="roomCodeDisplay" class="font-bold text-xl md:text-2xl" style="color: #1EA7D8;"></span></h2>
            <p class="text-sm text-gray-600">You are: <span id="currentPlayerName" class="font-semibold" style="color: #E85987;"></span></p>
          </div>
          <button onclick="leaveRoom()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 w-full md:w-auto">Leave</button>
        </div>
      </div>

      <div class="rounded-lg shadow-md p-4 md:p-6 mb-6" style="background-color: #F5E6D3;">
        <h3 class="font-semibold mb-4">Players in Room (<span id="playerCount">0</span>/12)</h3>
        <button onclick="randomizeTeams()" class="w-full px-6 py-2 text-white rounded-lg mb-4" style="background-color: #11462b;">⚡ Randomize Teams</button>
        <div id="adminScoreControls" class="hidden mb-4 flex gap-2">
          <button onclick="resetScores()" class="flex-1 px-4 py-2 text-white rounded-lg text-sm" style="background-color: #f5767d;">Reset All Scores</button>
        </div>
        <div id="playersList" class="space-y-2"></div>
      </div>

      <div class="rounded-lg shadow-md p-4 md:p-6 mb-6" style="background-color: #F5E6D3;">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Game Mode:</h3>
          <button onclick="toggleHelp()" class="w-6 h-6 rounded-full flex items-center justify-center text-white font-bold text-sm hover:opacity-80" style="background-color: #4E5987;" title="Help">?</button>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-4">
          <button onclick="setGameMode('all_see')" id="mode_all_see" class="px-4 py-2 rounded-lg text-sm" style="background-color: #E8F4D0;" title="Everyone can see the word">Everyone Sees</button>
          <button onclick="setGameMode('team_alternate')" id="mode_team_alternate" class="px-4 py-2 rounded-lg text-sm" style="background-color: #E8F4D0;" title="First Team A sees the word, then team B, then team A, etc.">Team Alternating</button>
          <button onclick="setGameMode('random_player')" id="mode_random_player" class="px-4 py-2 rounded-lg text-sm" style="background-color: #E8F4D0;" title="Everyone sees the word except one random player">Random Excluded</button>
          <button onclick="setGameMode('only_1_player')" id="mode_only_1_player" class="px-4 py-2 rounded-lg text-sm" style="background-color: #E8F4D0;" title="Nobody sees the word except for one random player">Only 1 Sees</button>
        </div>
        
        <div id="adminSettings" class="hidden mb-4 p-3 rounded-lg" style="background-color: #fefcea;">
          <h4 class="font-semibold text-sm mb-2">⚙️ Admin Settings</h4>
          <div class="space-y-2">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="forceAnonymous" onclick="toggleAnonymousMode()" class="w-4 h-4">
              <span class="text-sm">Force anonymous submissions</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="autoStartTimer" onclick="toggleAutoStartTimer()" class="w-4 h-4" checked>
              <span class="text-sm">Auto-start timer (10s after word reveal)</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="forceTextMode" onclick="toggleForceTextMode()" class="w-4 h-4">
              <span class="text-sm">Force text mode (disable drawing)</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="collaborativeDrawing" onclick="toggleCollaborativeDrawing()" class="w-4 h-4">
              <span class="text-sm">Collaborative drawing (alternating turns)</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="collaborativeStory" onclick="toggleCollaborativeStory()" class="w-4 h-4">
              <span class="text-sm">Collaborative story (3 words per turn)</span>
            </label>
            <div class="flex flex-wrap gap-2 items-center">
              <span class="text-sm font-medium">Default timer:</span>
              <button onclick="setDefaultTimer(30)" id="default_timer30" class="px-2 py-1 rounded text-xs bg-gray-200">30s</button>
              <button onclick="setDefaultTimer(60)" id="default_timer60" class="px-2 py-1 rounded text-xs bg-gray-200">60s</button>
              <button onclick="setDefaultTimer(90)" id="default_timer90" class="px-2 py-1 rounded text-xs bg-gray-200">90s</button>
              <button onclick="setDefaultTimer(120)" id="default_timer120" class="px-2 py-1 rounded text-xs bg-gray-200">120s</button>
            </div>
            <div class="flex gap-2 items-center pt-2">
              <button onclick="toggleTimer()" id="timerControlBtn" class="px-4 py-2 rounded text-sm text-white" style="background-color: #1EA7D8;">Start Timer</button>
              <button onclick="placeBets()" id="placeBetsBtn" class="px-4 py-2 rounded text-sm text-white hidden" style="background-color: #E85987;">Place Bets!</button>
            </div>
          </div>
        </div>
        
        <h3 class="font-semibold mb-2">Word Categories:</h3>
        <div class="grid grid-cols-2 gap-2">
          <label class="flex items-center gap-2 cursor-pointer px-3 py-2 rounded-lg text-sm" style="background-color: #1b1531; color: white;">
            <input type="checkbox" id="cat_nouns" checked onclick="toggleCategory('nouns')">
            <span>Nouns</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer px-3 py-2 rounded-lg text-sm" style="background-color: #1b1531; color: white;">
            <input type="checkbox" id="cat_adjectives" checked onclick="toggleCategory('adjectives')">
            <span>Adjectives</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer px-3 py-2 rounded-lg text-sm" style="background-color: #1b1531; color: white;">
            <input type="checkbox" id="cat_fancy" onclick="toggleCategory('fancyWords')">
            <span>Fancy Words</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer px-3 py-2 rounded-lg text-sm" style="background-color: #1b1531; color: white;">
            <input type="checkbox" id="cat_famous" onclick="toggleCategory('famousPeople')">
            <span>Famous People</span>
          </label>
        </div>
      </div>

      <div class="text-center mb-6 rounded-lg shadow-md p-4 md:p-6" style="background-color: #F5E6D3;">
        <button onclick="generateWord()" class="w-full px-6 md:px-8 py-3 md:py-4 text-white rounded-lg text-lg md:text-xl font-semibold" style="background-color: #1EA7D8;">🎲 Generate Word</button>
      </div>

      <div id="playersDisplay"></div>

      <!-- Answer Submission Area -->
      <div id="answerSection" class="hidden rounded-lg shadow-md p-4 md:p-6 mb-6" style="background-color: #F5E6D3;">
        <h3 class="font-semibold mb-3">Don't have pen and paper? Write or draw your answer here:</h3>
        
        <div class="mb-3 flex flex-wrap gap-2 items-center">
          <button onclick="setAnswerMode('draw')" id="mode_draw" class="px-4 py-2 rounded text-sm" style="background-color: #5E5394; color: white;">🎨 Draw</button>
          <button onclick="setAnswerMode('text')" id="mode_text" class="px-4 py-2 rounded text-sm bg-gray-200">✏️ Text</button>
          <span class="text-sm font-medium ml-auto">Timer:</span>
          <div id="timerDisplay" class="text-2xl font-bold" style="color: #E85987;">--</div>
        </div>

        <div id="collaborativeTurnIndicator" class="hidden mb-3 p-3 rounded-lg text-center font-semibold" style="background-color: #fefcea;">
          <span id="turnIndicatorText"></span>
        </div>

        <!-- Collaborative Story Display -->
        <div id="collaborativeStoryDisplay" class="hidden mb-3 p-4 rounded-lg" style="background-color: #E8F4D0;">
          <h4 class="font-semibold mb-2">Story So Far:</h4>
          <p id="storyText" class="text-lg leading-relaxed"></p>
        </div>

        <!-- Collaborative Story Input -->
        <div id="collaborativeStoryInput" class="hidden mb-3">
          <div class="flex gap-2">
            <input type="text" id="storyWord1" placeholder="Word 1" maxlength="20" class="flex-1 px-3 py-2 border-2 rounded-lg" style="border-color: #4E5987;">
            <input type="text" id="storyWord2" placeholder="Word 2" maxlength="20" class="flex-1 px-3 py-2 border-2 rounded-lg" style="border-color: #4E5987;">
            <input type="text" id="storyWord3" placeholder="Word 3" maxlength="20" class="flex-1 px-3 py-2 border-2 rounded-lg" style="border-color: #4E5987;">
          </div>
          <button onclick="submitStoryWords()" id="submitStoryBtn" class="w-full mt-2 px-4 py-2 text-white rounded-lg font-semibold" style="background-color: #E85987;">Add My 3 Words</button>
        </div>

        <!-- Drawing Mode -->
        <div id="drawMode">
          <div class="mb-3 flex flex-wrap gap-2">
            <button onclick="setTool('pen')" id="tool_pen" class="px-3 py-1 rounded text-sm" style="background-color: #5E5394; color: white;">✏️ Pen</button>
            <button onclick="setTool('eraser')" id="tool_eraser" class="px-3 py-1 rounded text-sm bg-gray-200">🧹 Eraser</button>
            <button onclick="clearCanvas()" class="px-3 py-1 rounded text-sm bg-gray-200">🗑️ Clear</button>
            <input type="color" id="colorPicker" value="#000000" class="h-8 w-12 rounded">
            <input type="range" id="brushSize" min="1" max="20" value="3" class="flex-1 min-w-[100px]">
          </div>
          <canvas id="canvas" width="600" height="400" class="w-full bg-white rounded-lg mb-3"></canvas>
        </div>

        <!-- Text Mode -->
        <div id="textMode" class="hidden">
          <textarea id="textAnswer" placeholder="Type your answer here..." class="w-full h-64 p-4 border-2 rounded-lg mb-3 text-lg" style="border-color: #4E5987;"></textarea>
        </div>
        
        <div class="flex gap-2">
          <button onclick="submitAnswer()" id="submitBtn" class="flex-1 px-6 py-3 text-white rounded-lg font-semibold" style="background-color: #E85987;">Submit Answer</button>
          <div id="submissionStatus" class="flex-1 px-6 py-3 bg-gray-100 rounded-lg text-center font-medium text-gray-600">
            Waiting: <span id="submittedCount">0</span>/<span id="totalPlayers">0</span>
          </div>
        </div>
      </div>

      <!-- Betting Section -->
      <div id="bettingSection" class="hidden rounded-lg shadow-md p-4 md:p-6 mb-6" style="background-color: #F5E6D3;">
        <h3 class="font-semibold mb-3">Review & Place Your Bet!</h3>
        <p class="text-sm text-gray-600 mb-4">Navigate through answers and select which one you think matches the word best.</p>
        
        <div id="readAnswersBtn" class="mb-4">
          <button onclick="startReading()" class="w-full px-6 py-3 text-white rounded-lg font-semibold text-lg" style="background-color: #5E5394;">📖 Start Reading Answers</button>
        </div>

        <div id="navigationControls" class="hidden">
          <div class="mb-4 flex justify-between items-center">
            <button onclick="prevAnswer()" class="px-4 py-2 rounded text-white" style="background-color: #5E5394;">← Previous</button>
            <span class="font-semibold">Answer <span id="currentAnswerIndex">1</span> of <span id="totalAnswers">0</span></span>
            <button onclick="nextAnswer()" class="px-4 py-2 rounded text-white" style="background-color: #5E5394;">Next →</button>
          </div>

          <div id="currentAnswerDisplay" class="bg-white rounded-lg p-6 mb-4 min-h-[300px] flex items-center justify-center"></div>

          <button onclick="selectAnswer()" id="selectAnswerBtn" class="w-full px-6 py-3 text-white rounded-lg font-semibold text-lg" style="background-color: #E85987;">This One!</button>
          
          <div id="betStatus" class="hidden mt-4 p-3 bg-green-100 rounded-lg text-center">
            <p class="font-semibold text-green-800">✓ Bet Placed!</p>
          </div>

          <div id="adminBettingControls" class="hidden mt-4">
            <button onclick="showResultsManual()" class="w-full px-6 py-3 text-white rounded-lg font-semibold" style="background-color: #11462b;">Show Results Now</button>
          </div>
        </div>
      </div>

      <!-- Round Results Section -->
      <div id="resultsSection" class="hidden rounded-lg shadow-md p-4 md:p-6 mb-6" style="background-color: #F5E6D3;">
        <h3 class="font-semibold text-xl mb-4 text-center" style="color: #4E5987;">Round Results</h3>
        
        <div class="mb-4 p-4 rounded-lg text-center" style="background-color: #E8F4D0;">
          <p class="text-sm text-gray-600 mb-2">The word was:</p>
          <p class="text-3xl font-bold" style="color: #5E5394;"><span id="revealedWord"></span></p>
        </div>

        <div id="roundSummary" class="space-y-3 mb-4"></div>

        <div id="scoreChanges" class="mb-4 p-4 rounded-lg" style="background-color: #fff;">
          <h4 class="font-semibold mb-3 text-center">Score Changes</h4>
          <div id="scoreChangesList" class="space-y-2"></div>
        </div>

        <div id="adminResultsControls" class="hidden flex gap-2">
          <button onclick="nextRound()" class="flex-1 px-6 py-3 text-white rounded-lg font-semibold text-lg" style="background-color: #1EA7D8;">Next Round</button>
        </div>
      </div>

      <!-- Help Modal -->
      <div id="helpModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="closeHelpIfClickOutside(event)">
        <div class="rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" style="background-color: #F5E6D3;" onclick="event.stopPropagation()">
          <div class="p-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-bold" style="color: #4E5987;">Help & Information</h2>
              <button onclick="toggleHelp()" class="text-3xl text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            
            <div class="space-y-6">
              <div>
                <h3 class="font-semibold text-lg mb-3" style="color: #4E5987;">Game Modes:</h3>
                <div class="space-y-2 text-sm">
                  <div class="p-3 rounded" style="background-color: #fefcea;">
                    <strong>Everyone Sees:</strong> Everyone can see the word.
                  </div>
                  <div class="p-3 rounded" style="background-color: #fefcea;">
                    <strong>Team Alternating:</strong> First Team A sees the word, then team B, then team A, etc.
                  </div>
                  <div class="p-3 rounded" style="background-color: #fefcea;">
                    <strong>Random Excluded:</strong> Everyone sees the word except one random player.
                  </div>
                  <div class="p-3 rounded" style="background-color: #fefcea;">
                    <strong>Only 1 Sees:</strong> Nobody sees the word except for one random player.
                  </div>
                </div>
              </div>

              <div>
                <h3 class="font-semibold text-lg mb-3" style="color: #4E5987;">Admin Settings:</h3>
                <div class="space-y-2 text-sm">
                  <div class="p-3 rounded" style="background-color: #fefcea;">
                    <strong>Force anonymous submissions:</strong> All submitted answers will be shown as "Anonymous" instead of player names.
                  </div>
                  <div class="p-3 rounded" style="background-color: #fefcea;">
                    <strong>Auto-start timer:</strong> Timer automatically starts 10 seconds after a word is revealed. If disabled, admin must manually start the timer.
                  </div>
                  <div class="p-3 rounded" style="background-color: #fefcea;">
                    <strong>Force text mode:</strong> Disables drawing mode for all players, forcing them to submit text answers only.
                  </div>
                  <div class="p-3 rounded" style="background-color: #fefcea;">
                    <strong>Collaborative drawing:</strong> Players take turns drawing one stroke at a time on a shared canvas, each with their own color. Only when a player submits is the collaborative drawing complete.
                  </div>
                  <div class="p-3 rounded" style="background-color: #fefcea;">
                    <strong>Collaborative story:</strong> Players take turns adding exactly 3 words to build a story together. Each player contributes in sequence until everyone has added their words, then the complete story is submitted as the answer.
                  </div>
                  <div class="p-3 rounded" style="background-color: #fefcea;">
                    <strong>Default timer:</strong> Sets the countdown timer duration (30s, 60s, 90s, or 120s) for answering.
                  </div>
                </div>
              </div>

              <div>
                <h3 class="font-semibold text-lg mb-3" style="color: #4E5987;">How to Play:</h3>
                <div class="space-y-2 text-sm">
                  <div class="p-3 rounded" style="background-color: #fefcea;">
                    <strong>Submitting Answers:</strong> After a word is generated, players see their word (depending on game mode) and submit an answer by drawing or typing. Once all players submit, the admin can start the betting phase.
                  </div>
                  <div class="p-3 rounded" style="background-color: #fefcea;">
                    <strong>Placing Bets:</strong> When the admin clicks "Place Bets", all players navigate through the submitted answers and vote on which answer best matches the word. In some game modes, players try to guess which answer belongs to the player who saw the word.
                  </div>
                  <div class="p-3 rounded" style="background-color: #fefcea;">
                    <strong>Scoring Points:</strong> After betting, the admin shows results. Players earn points automatically based on correct guesses. In "Random Excluded" and "Only 1 Sees" modes, players who correctly identify the word-holder's answer get +1 point, and the word-holder gets +1 point for each correct guess. Admins can also manually adjust scores using the +/- buttons in the player list.
                  </div>
                </div>
              </div>
            </div>

            <button onclick="toggleHelp()" class="mt-6 w-full px-6 py-3 text-white rounded-lg font-semibold" style="background-color: #1EA7D8;">Got it!</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Landing Page Help Modal -->
    <div id="landingHelpModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="closeLandingHelpIfClickOutside(event)">
      <div class="rounded-lg shadow-xl max-w-lg w-full" style="background-color: #F5E6D3;" onclick="event.stopPropagation()">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold" style="color: #4E5987;">How It Works</h2>
            <button onclick="toggleLandingHelp()" class="text-3xl text-gray-500 hover:text-gray-700">&times;</button>
          </div>
          
          <div class="p-4 rounded-lg mb-4" style="background-color: #fefcea;">
            <p class="text-gray-700 leading-relaxed">
              Create a room, share the code with friends, and play word games with settings to your choosing. No paper needed.
            </p>
          </div>

          <button onclick="toggleLandingHelp()" class="w-full px-6 py-3 text-white rounded-lg font-semibold" style="background-color: #1EA7D8;">Got it!</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAtcCz7buZmEoLflrxKcf7vFYY3YOG5gdM",
      authDomain: "nounsandfrowns.firebaseapp.com",
      databaseURL: "https://nounsandfrowns-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "nounsandfrowns",
      storageBucket: "nounsandfrowns.firebasestorage.app",
      messagingSenderId: "948424078081",
      appId: "1:948424078081:web:8dcae9f01988fd8a7ca100"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.db = db;
    window.roomCode = null;
    window.currentPlayerId = null;
    window.currentPlayerName = null;
    window.roomAdminId = null;

    // Load banner on page load
    onValue(ref(db, 'globalSettings/bannerUrl'), (snap) => {
      const bannerUrl = snap.val();
      if (bannerUrl) {
        document.getElementById('bannerImage').src = bannerUrl;
        document.getElementById('bannerImage').style.display = 'block';
        document.getElementById('bannerPlaceholder').style.display = 'none';
      } else {
        document.getElementById('bannerImage').style.display = 'none';
        document.getElementById('bannerPlaceholder').style.display = 'block';
      }
    });

    // Toggle Help Modal
    window.toggleHelp = function() {
      const modal = document.getElementById('helpModal');
      if (modal.classList.contains('hidden')) {
        modal.classList.remove('hidden');
      } else {
        modal.classList.add('hidden');
      }
    };

    // Toggle Landing Help Modal
    window.toggleLandingHelp = function() {
      const modal = document.getElementById('landingHelpModal');
      if (modal.classList.contains('hidden')) {
        modal.classList.remove('hidden');
      } else {
        modal.classList.add('hidden');
      }
    };

    // Close modals when clicking outside
    window.closeHelpIfClickOutside = function(event) {
      if (event.target.id === 'helpModal') {
        toggleHelp();
      }
    };

    window.closeLandingHelpIfClickOutside = function(event) {
      if (event.target.id === 'landingHelpModal') {
        toggleLandingHelp();
      }
    };

    // Canvas setup
    let canvas, ctx;
    let drawing = false;
    let currentTool = 'pen';
    let currentColor = '#000000';
    let brushSize = 3;
    let timerInterval = null;
    let selectedTimer = 60;
    let timeRemaining = 0;
    let answerMode = 'draw';
    let timerRunning = false;
    let bettingAnswers = [];
    let currentBettingIndex = 0;
    window.pendingScoreChanges = {};

    window.WORDS = {
      nouns: ['elephant', 'mountain', 'symphony', 'laboratory', 'adventure', 'telescope', 'cathedral', 'volcano', 'library', 'hurricane', 'galaxy', 'fortress', 'ocean', 'pyramid', 'metropolis', 'compass', 'desert', 'waterfall', 'monastery', 'carnival', 'labyrinth', 'meadow', 'archipelago', 'castle', 'valley', 'aurora', 'canyon', 'jungle', 'peninsula', 'sanctuary', 'butterfly', 'dragon', 'unicorn', 'phoenix', 'lighthouse', 'glacier', 'earthquake', 'tornado', 'avalanche', 'eclipse', 'comet', 'nebula', 'asteroid', 'satellite', 'rocket', 'submarine', 'helicopter', 'parachute', 'microscope', 'binoculars'],
      adjectives: ['magnificent', 'peculiar', 'tremendous', 'delicate', 'mysterious', 'brilliant', 'ancient', 'graceful', 'turbulent', 'serene', 'spectacular', 'elegant', 'ferocious', 'luminous', 'tranquil', 'vibrant', 'majestic', 'bizarre', 'harmonious', 'resilient', 'exquisite', 'radiant', 'enigmatic', 'colossal', 'whimsical', 'pristine', 'formidable', 'ethereal', 'splendid', 'dazzling', 'gleaming', 'shimmering', 'sparkling', 'glittering', 'blazing', 'glowing', 'flickering', 'twinkling', 'shining', 'vivid', 'bold', 'striking', 'dramatic', 'intense', 'powerful', 'mighty', 'strong', 'robust', 'sturdy', 'solid'],
      fancyWords: ['obsequious', 'perspicacious', 'recalcitrant', 'ephemeral', 'ubiquitous', 'vociferous', 'pulchritude', 'quintessential', 'serendipity', 'lackadaisical', 'magnanimous', 'nefarious', 'obfuscate', 'perfidious', 'pusillanimous', 'querulous', 'sagacious', 'sanguine', 'taciturn', 'unctuous', 'verbose', 'zealous'],
      famousPeople: ['Marilyn Monroe', 'Albert Einstein', 'Leonardo da Vinci', 'Iron Man', 'Batman', 'Superman', 'Harry Potter', 'Hermione Granger', 'Luke Skywalker', 'Darth Vader', 'Sherlock Holmes', 'James Bond', 'Spider-Man', 'Wonder Woman', 'Captain America', 'Thor', 'Hulk', 'Black Widow', 'Jon Snow', 'Daenerys Targaryen', 'Marie Curie', 'Isaac Newton', 'Stephen Hawking', 'Nikola Tesla', 'Charles Darwin', 'George Washington', 'Abraham Lincoln', 'Nelson Mandela', 'Winston Churchill', 'Martin Luther King Jr.', 'Mahatma Gandhi', 'Rosa Parks', 'Mother Teresa', 'Cleopatra', 'Julius Caesar', 'Napoleon Bonaparte']
    };

    function initCanvas() {
      canvas = document.getElementById('canvas');
      ctx = canvas.getContext('2d');
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);

      canvas.addEventListener('touchstart', handleTouch);
      canvas.addEventListener('touchmove', handleTouch);
      canvas.addEventListener('touchend', stopDrawing);

      document.getElementById('colorPicker').addEventListener('change', (e) => {
        currentColor = e.target.value;
      });

      document.getElementById('brushSize').addEventListener('input', (e) => {
        brushSize = e.target.value;
      });
    }

    function startDrawing(e) {
      onValue(ref(db, `rooms/${window.roomCode}`), (snap) => {
        const data = snap.val();
        if (data && data.collaborativeDrawing && !isMyTurn(data)) {
          return;
        }
        
        drawing = true;
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;
        ctx.beginPath();
        ctx.moveTo(x, y);
      }, { onlyOnce: true });
    }

    function draw(e) {
      if (!drawing) return;
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;
      
      ctx.lineWidth = brushSize;
      ctx.strokeStyle = currentTool === 'eraser' ? '#ffffff' : currentColor;
      ctx.lineTo(x, y);
      ctx.stroke();
    }

    function stopDrawing() {
      if (drawing) {
        onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
          const data = snap.val();
          if (data && data.collaborativeDrawing && isMyTurn(data)) {
            // Save canvas to Firebase before advancing turn
            const canvasData = canvas.toDataURL();
            await update(ref(db, `rooms/${window.roomCode}`), { 
              canvasData: canvasData 
            });
            advanceTurn(data);
          }
        }, { onlyOnce: true });
      }
      drawing = false;
    }

    function handleTouch(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
    }

    function loadCanvasFromData(dataUrl) {
      const img = new Image();
      img.onload = function() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
      };
      img.src = dataUrl;
    }

    window.submitStoryWords = async function() {
      const word1 = document.getElementById('storyWord1').value.trim();
      const word2 = document.getElementById('storyWord2').value.trim();
      const word3 = document.getElementById('storyWord3').value.trim();
      
      if (!word1 || !word2 || !word3) {
        return alert('Please enter all 3 words');
      }
      
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        if (!data.collaborativeStory) return;
        
        const storyWords = data.storyWords || [];
        storyWords.push({ 
          playerId: window.currentPlayerId, 
          playerName: window.currentPlayerName,
          words: [word1, word2, word3] 
        });
        
        const nextTurn = ((data.currentStoryTurn || 0) + 1) % data.players.length;
        
        await update(ref(db, `rooms/${window.roomCode}`), { 
          storyWords: storyWords,
          currentStoryTurn: nextTurn
        });
        
        document.getElementById('storyWord1').value = '';
        document.getElementById('storyWord2').value = '';
        document.getElementById('storyWord3').value = '';
      }, { onlyOnce: true });
    };

    window.setTool = function(tool) {
      currentTool = tool;
      document.getElementById('tool_pen').style.backgroundColor = tool === 'pen' ? '#5E5394' : '#E5E7EB';
      document.getElementById('tool_pen').style.color = tool === 'pen' ? '#fff' : '#000';
      document.getElementById('tool_eraser').style.backgroundColor = tool === 'eraser' ? '#5E5394' : '#E5E7EB';
      document.getElementById('tool_eraser').style.color = tool === 'eraser' ? '#fff' : '#000';
    };

    window.clearCanvas = function() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    };

    window.setAnswerMode = function(mode) {
      onValue(ref(db, `rooms/${window.roomCode}`), (snap) => {
        const data = snap.val();
        if (data && data.forceTextMode && mode === 'draw') {
          alert('Drawing mode is disabled by the admin');
          return;
        }
        
        answerMode = mode;
        document.getElementById('mode_draw').style.backgroundColor = mode === 'draw' ? '#5E5394' : '#E5E7EB';
        document.getElementById('mode_draw').style.color = mode === 'draw' ? '#fff' : '#000';
        document.getElementById('mode_text').style.backgroundColor = mode === 'text' ? '#5E5394' : '#E5E7EB';
        document.getElementById('mode_text').style.color = mode === 'text' ? '#fff' : '#000';
        
        if (mode === 'draw') {
          document.getElementById('drawMode').classList.remove('hidden');
          document.getElementById('textMode').classList.add('hidden');
        } else {
          document.getElementById('drawMode').classList.add('hidden');
          document.getElementById('textMode').classList.remove('hidden');
        }
      }, { onlyOnce: true });
    };

    window.setTimer = function(seconds) {
      selectedTimer = seconds;
    };

    window.setDefaultTimer = async function(seconds) {
      if (window.currentPlayerId !== window.roomAdminId) return;
      await update(ref(db, `rooms/${window.roomCode}`), { defaultTimer: seconds });
    };

    window.toggleAnonymousMode = async function() {
      if (window.currentPlayerId !== window.roomAdminId) return;
      const checked = document.getElementById('forceAnonymous').checked;
      await update(ref(db, `rooms/${window.roomCode}`), { forceAnonymous: checked });
    };

    window.toggleAutoStartTimer = async function() {
      if (window.currentPlayerId !== window.roomAdminId) return;
      const checked = document.getElementById('autoStartTimer').checked;
      await update(ref(db, `rooms/${window.roomCode}`), { autoStartTimer: checked });
    };

    window.toggleForceTextMode = async function() {
      if (window.currentPlayerId !== window.roomAdminId) return;
      const checked = document.getElementById('forceTextMode').checked;
      await update(ref(db, `rooms/${window.roomCode}`), { forceTextMode: checked });
    };

    window.toggleCollaborativeDrawing = async function() {
      if (window.currentPlayerId !== window.roomAdminId) return;
      const checked = document.getElementById('collaborativeDrawing').checked;
      if (checked) {
        document.getElementById('collaborativeStory').checked = false;
      }
      await update(ref(db, `rooms/${window.roomCode}`), { 
        collaborativeDrawing: checked,
        collaborativeStory: false,
        currentDrawingTurn: checked ? 0 : null,
        canvasData: checked ? null : undefined
      });
    };

    window.toggleCollaborativeStory = async function() {
      if (window.currentPlayerId !== window.roomAdminId) return;
      const checked = document.getElementById('collaborativeStory').checked;
      if (checked) {
        document.getElementById('collaborativeDrawing').checked = false;
      }
      await update(ref(db, `rooms/${window.roomCode}`), { 
        collaborativeStory: checked,
        collaborativeDrawing: false,
        currentStoryTurn: checked ? 0 : null,
        storyWords: checked ? [] : undefined
      });
    };

    const playerColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B500', '#52B788', '#E63946', '#457B9D'];

    function getPlayerColor(playerIndex) {
      return playerColors[playerIndex % playerColors.length];
    }

    function isMyTurn(data) {
      if (!data.collaborativeDrawing) return true;
      if (!data.players) return false;
      
      const currentTurnIndex = data.currentDrawingTurn || 0;
      const currentTurnPlayer = data.players[currentTurnIndex];
      return currentTurnPlayer && currentTurnPlayer.id === window.currentPlayerId;
    }

    function advanceTurn(data) {
      if (!data.collaborativeDrawing || !data.players) return;
      
      const nextTurn = ((data.currentDrawingTurn || 0) + 1) % data.players.length;
      update(ref(db, `rooms/${window.roomCode}`), { currentDrawingTurn: nextTurn });
    }

    window.startTimer = function() {
      if (timerInterval) clearInterval(timerInterval);
      timeRemaining = selectedTimer;
      timerRunning = true;
      updateTimerButton();
      document.getElementById('timerDisplay').textContent = timeRemaining + 's';
      
      timerInterval = setInterval(() => {
        timeRemaining--;
        document.getElementById('timerDisplay').textContent = timeRemaining + 's';
        if (timeRemaining <= 0) {
          clearInterval(timerInterval);
          timerRunning = false;
          updateTimerButton();
          document.getElementById('timerDisplay').textContent = 'TIME!';
        }
      }, 1000);
    };

    window.stopTimer = function() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      timerRunning = false;
      updateTimerButton();
    };

    window.toggleTimer = function() {
      if (timerRunning) {
        stopTimer();
      } else {
        startTimer();
      }
    };

    function updateTimerButton() {
      const btn = document.getElementById('timerControlBtn');
      if (btn) {
        btn.textContent = timerRunning ? 'Stop Timer' : 'Start Timer';
        btn.style.backgroundColor = timerRunning ? '#EF4444' : '#1EA7D8';
      }
    }

    window.placeBets = async function() {
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        if (!data.submissions || Object.keys(data.submissions).length === 0) {
          return alert('No answers submitted yet!');
        }
        
        await update(ref(db, `rooms/${window.roomCode}`), { 
          bettingMode: true,
          bets: {},
          showResults: false,
          readingStarted: false
        });
        
        stopTimer();
      }, { onlyOnce: true });
    };

    window.startReading = async function() {
      await update(ref(db, `rooms/${window.roomCode}`), { readingStarted: true });
    };

    window.prevAnswer = function() {
      if (currentBettingIndex > 0) {
        currentBettingIndex--;
        displayCurrentBettingAnswer();
      }
    };

    window.nextAnswer = function() {
      if (currentBettingIndex < bettingAnswers.length - 1) {
        currentBettingIndex++;
        displayCurrentBettingAnswer();
      }
    };

    window.selectAnswer = async function() {
      if (bettingAnswers.length === 0) return;
      
      const selectedAnswer = bettingAnswers[currentBettingIndex];
      
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        const bets = data.bets || {};
        bets[window.currentPlayerId] = {
          playerId: window.currentPlayerId,
          selectedAnswerId: selectedAnswer.playerId,
          timestamp: Date.now()
        };
        
        await update(ref(db, `rooms/${window.roomCode}`), { bets });
        document.getElementById('betStatus').classList.remove('hidden');
        document.getElementById('selectAnswerBtn').disabled = true;
      }, { onlyOnce: true });
    };

    function displayCurrentBettingAnswer() {
      if (bettingAnswers.length === 0) return;
      
      const answer = bettingAnswers[currentBettingIndex];
      const container = document.getElementById('currentAnswerDisplay');
      
      if (answer.answerType === 'text') {
        container.innerHTML = `<div class="text-2xl font-medium text-center p-4">${answer.answer}</div>`;
      } else {
        container.innerHTML = `<img src="${answer.answer}" class="max-w-full max-h-[400px] rounded">`;
      }
      
      document.getElementById('currentAnswerIndex').textContent = currentBettingIndex + 1;
    }

    window.adjustScore = async function(playerId, amount) {
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        const players = data.players.map(p => {
          if (p.id === playerId) {
            return { ...p, score: (p.score || 0) + amount };
          }
          return p;
        });
        await update(ref(db, `rooms/${window.roomCode}`), { players });
      }, { onlyOnce: true });
    };

    window.resetScores = async function() {
      if (!confirm('Reset all player scores to 0?')) return;
      
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        const players = data.players.map(p => ({ ...p, score: 0 }));
        await update(ref(db, `rooms/${window.roomCode}`), { players });
      }, { onlyOnce: true });
    };

    window.autoStartTimer = function(defaultTime, autoStart) {
      selectedTimer = defaultTime || 60;
      if (autoStart) {
        setTimeout(() => {
          window.startTimer();
        }, 10000);
      }
    };

    window.submitAnswer = async function() {
      let answerData;
      let answerType;
      
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        
        if (data.collaborativeStory) {
          // For collaborative story, compile all the words
          const storyWords = data.storyWords || [];
          answerData = storyWords.map(entry => entry.words.join(' ')).join(' ');
          answerType = 'text';
        } else if (answerMode === 'draw') {
          answerData = canvas.toDataURL();
          answerType = 'drawing';
        } else {
          answerData = document.getElementById('textAnswer').value.trim();
          if (!answerData) return alert('Please enter your answer');
          answerType = 'text';
        }
        
        const isAnonymous = data.forceAnonymous || false;
        const submissions = data.submissions || {};
        submissions[window.currentPlayerId] = {
          playerId: window.currentPlayerId,
          playerName: isAnonymous ? 'Anonymous' : window.currentPlayerName,
          answer: answerData,
          answerType: answerType,
          timestamp: Date.now(),
          isAnonymous: isAnonymous
        };
        
        await update(ref(db, `rooms/${window.roomCode}`), { submissions });
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('submitBtn').textContent = '✓ Submitted';
      }, { onlyOnce: true });
    };

    window.createRoom = async function() {
      const name = document.getElementById('createPlayerName').value.trim();
      const pwd = document.getElementById('createPassword').value;
      
      if (!name) return alert('Enter your name');
      if (!pwd || pwd.length < 4) return alert('Password must be 4+ chars');
      
      const code = Math.floor(1000 + Math.random() * 9000).toString();
      const playerId = Date.now();
      
      window.currentPlayerId = playerId;
      window.currentPlayerName = name;
      window.roomAdminId = playerId;
      
      await set(ref(db, `rooms/${code}`), {
        password: pwd,
        adminId: playerId,
        players: [{ id: playerId, name, team: null, score: 0 }],
        currentWord: '',
        currentWordType: '',
        gameMode: 'all_see',
        round: 0,
        excludedPlayer: null,
        wordCategories: { nouns: true, adjectives: true, famousPeople: false, fancyWords: false },
        showDefinitions: {},
        submissions: {},
        answerVisibility: 'all',
        forceAnonymous: false,
        autoStartTimer: true,
        forceTextMode: false,
        collaborativeDrawing: false,
        collaborativeStory: false,
        currentDrawingTurn: null,
        currentStoryTurn: null,
        canvasData: null,
        storyWords: [],
        defaultTimer: 60,
        bets: {},
        bettingMode: false,
        showResults: false,
        readingStarted: false
      });
      
      window.roomCode = code;
      document.getElementById('lobby').classList.add('hidden');
      document.getElementById('landingHelpModal').classList.add('hidden');
      document.getElementById('gameRoom').classList.remove('hidden');
      document.getElementById('roomCodeDisplay').textContent = code;
      document.getElementById('currentPlayerName').textContent = name;
      initCanvas();
      listenToRoom(code);
    };

    window.joinRoom = async function() {
      const name = document.getElementById('joinPlayerName').value.trim();
      const code = document.getElementById('joinRoomCode').value.trim();
      const pwd = document.getElementById('joinPassword').value;
      
      if (!name) return alert('Enter your name');
      if (!code || !pwd) return alert('Enter code and password');
      
      try {
        const snapshot = await new Promise((resolve) => {
          onValue(ref(db, `rooms/${code}`), (snap) => {
            resolve(snap);
          }, { onlyOnce: true });
        });
        
        const data = snapshot.val();
        if (!data) return alert('Room not found');
        if (data.password !== pwd) return alert('Wrong password');
        
        const players = data.players || [];
        if (players.length >= 12) return alert('Room full (12 players max)');
        
        const playerId = Date.now();
        window.currentPlayerId = playerId;
        window.currentPlayerName = name;
        window.roomAdminId = data.adminId;
        
        players.push({ id: playerId, name, team: null, score: 0 });
        await update(ref(db, `rooms/${code}`), { players });
        
        window.roomCode = code;
        document.getElementById('lobby').classList.add('hidden');
        document.getElementById('landingHelpModal').classList.add('hidden');
        document.getElementById('gameRoom').classList.remove('hidden');
        document.getElementById('roomCodeDisplay').textContent = code;
        document.getElementById('currentPlayerName').textContent = name;
        initCanvas();
        listenToRoom(code);
      } catch (error) {
        console.error('Error joining room:', error);
        alert('Error joining room. Please try again.');
      }
    };

    function listenToRoom(code) {
      onValue(ref(db, `rooms/${code}`), (snap) => {
        const data = snap.val();
        if (data) updateUI(data);
      });
    }

    function updateUI(data) {
      document.getElementById('playerCount').textContent = data.players ? data.players.length : 0;
      
      const isAdmin = window.currentPlayerId === data.adminId;
      const adminPanel = document.getElementById('adminSettings');
      if (isAdmin) {
        adminPanel.classList.remove('hidden');
        document.getElementById('forceAnonymous').checked = data.forceAnonymous || false;
        document.getElementById('autoStartTimer').checked = data.autoStartTimer !== false;
        document.getElementById('forceTextMode').checked = data.forceTextMode || false;
        document.getElementById('collaborativeDrawing').checked = data.collaborativeDrawing || false;
        document.getElementById('collaborativeStory').checked = data.collaborativeStory || false;
        
        const defaultTimer = data.defaultTimer || 60;
        [30, 60, 90, 120].forEach(s => {
          const btn = document.getElementById(`default_timer${s}`);
          if (btn) {
            btn.style.backgroundColor = s === defaultTimer ? '#5E5394' : '#E5E7EB';
            btn.style.color = s === defaultTimer ? '#fff' : '#000';
          }
        });
      } else {
        adminPanel.classList.add('hidden');
      }
      
      if (data.defaultTimer) {
        selectedTimer = data.defaultTimer;
      }
      
      if (data.forceTextMode) {
        document.getElementById('mode_draw').style.opacity = '0.5';
        document.getElementById('mode_draw').style.cursor = 'not-allowed';
        if (answerMode === 'draw') {
          setAnswerMode('text');
        }
      } else {
        document.getElementById('mode_draw').style.opacity = '1';
        document.getElementById('mode_draw').style.cursor = 'pointer';
      }
      
      const list = document.getElementById('playersList');
      list.innerHTML = '';
      if (data.players && data.players.length > 0) {
        data.players.forEach(p => {
          const div = document.createElement('div');
          const isCurrentPlayer = p.id === window.currentPlayerId;
          const score = p.score || 0;
          div.className = `flex flex-col sm:flex-row items-stretch sm:items-center gap-2 p-2 rounded ${isCurrentPlayer ? '' : 'bg-gray-50'}`;
          if (isCurrentPlayer) {
            div.style.backgroundColor = '#fefcea';
          }
          div.innerHTML = `
            <span class="flex-1 font-medium text-sm">${p.name}${isCurrentPlayer ? ' (You)' : ''} <span class="ml-2 px-2 py-1 rounded text-xs" style="background-color: #E8F4D0;">Score: ${score}</span></span>
            <div class="flex gap-1">
              <button onclick="setTeam(${p.id}, 'A')" class="flex-1 sm:flex-none px-2 py-1 rounded text-white text-xs" style="background-color: ${p.team === 'A' ? '#5E5394' : '#E5E7EB'}; color: ${p.team === 'A' ? '#fff' : '#000'}">Team A</button>
              <button onclick="setTeam(${p.id}, 'B')" class="flex-1 sm:flex-none px-2 py-1 rounded text-white text-xs" style="background-color: ${p.team === 'B' ? '#E85987' : '#E5E7EB'}; color: ${p.team === 'B' ? '#fff' : '#000'}">Team B</button>
              <button onclick="setTeam(${p.id}, null)" class="flex-1 sm:flex-none px-2 py-1 rounded text-xs ${p.team === null ? 'bg-gray-400 text-white' : 'bg-gray-200'}">None</button>
              <button onclick="removePlayer(${p.id})" class="flex-1 sm:flex-none px-2 py-1 bg-red-500 text-white rounded text-xs">Remove</button>
              ${isAdmin ? `<button onclick="adjustScore(${p.id}, 1)" class="flex-1 sm:flex-none px-2 py-1 bg-green-500 text-white rounded text-xs">+</button>` : ''}
              ${isAdmin ? `<button onclick="adjustScore(${p.id}, -1)" class="flex-1 sm:flex-none px-2 py-1 bg-orange-500 text-white rounded text-xs">-</button>` : ''}
            </div>
          `;
          list.appendChild(div);
        });
      }
      
      if (isAdmin) {
        document.getElementById('adminScoreControls').classList.remove('hidden');
      } else {
        document.getElementById('adminScoreControls').classList.add('hidden');
      }
      
      ['all_see', 'team_alternate', 'random_player', 'only_1_player'].forEach(mode => {
        const btn = document.getElementById(`mode_${mode}`);
        if (data.gameMode === mode) {
          btn.style.backgroundColor = '#29522d';
          btn.style.color = '#fff';
        } else {
          btn.style.backgroundColor = '#E8F4D0';
          btn.style.color = '#000';
        }
        
        if (!isAdmin) {
          btn.style.opacity = '0.5';
          btn.style.cursor = 'not-allowed';
          btn.onclick = null;
        } else {
          btn.style.opacity = '1';
          btn.style.cursor = 'pointer';
        }
      });
      
      if (data.wordCategories) {
        ['nouns', 'adjectives', 'fancyWords', 'famousPeople'].forEach(cat => {
          const checkbox = document.getElementById(`cat_${cat === 'fancyWords' ? 'fancy' : cat === 'famousPeople' ? 'famous' : cat}`);
          if (checkbox) {
            checkbox.checked = data.wordCategories[cat];
            checkbox.disabled = !isAdmin;
            if (!isAdmin) {
              checkbox.parentElement.style.opacity = '0.7';
              checkbox.parentElement.style.cursor = 'not-allowed';
            } else {
              checkbox.parentElement.style.opacity = '1';
              checkbox.parentElement.style.cursor = 'pointer';
            }
          }
        });
      }
      
      displayPlayerCards(data);
      updateSubmissionStatus(data);
      updateBettingSection(data);
    }

    function updateBettingSection(data) {
      const bettingSection = document.getElementById('bettingSection');
      const resultsSection = document.getElementById('resultsSection');
      
      if (data.showResults) {
        bettingSection.classList.add('hidden');
        showRoundResults(data);
        return;
      }
      
      if (data.bettingMode && data.submissions) {
        bettingSection.classList.remove('hidden');
        resultsSection.classList.add('hidden');
        
        if (data.readingStarted) {
          document.getElementById('readAnswersBtn').classList.add('hidden');
          document.getElementById('navigationControls').classList.remove('hidden');
          
          bettingAnswers = Object.values(data.submissions).sort(() => Math.random() - 0.5);
          document.getElementById('totalAnswers').textContent = bettingAnswers.length;
          
          if (bettingAnswers.length > 0) {
            currentBettingIndex = 0;
            displayCurrentBettingAnswer();
          }
        } else {
          document.getElementById('readAnswersBtn').classList.remove('hidden');
          document.getElementById('navigationControls').classList.add('hidden');
        }
        
        if (data.bets && data.bets[window.currentPlayerId]) {
          document.getElementById('betStatus').classList.remove('hidden');
          document.getElementById('selectAnswerBtn').disabled = true;
        } else {
          document.getElementById('betStatus').classList.add('hidden');
          document.getElementById('selectAnswerBtn').disabled = false;
        }
        
        const isAdmin = window.currentPlayerId === data.adminId;
        if (isAdmin) {
          document.getElementById('adminBettingControls').classList.remove('hidden');
        } else {
          document.getElementById('adminBettingControls').classList.add('hidden');
        }
        
        const totalPlayers = data.players ? data.players.length : 0;
        const totalBets = data.bets ? Object.keys(data.bets).length : 0;
        
        if (totalBets === totalPlayers && window.currentPlayerId === data.adminId) {
          setTimeout(() => showResults(data), 1000);
        }
      } else {
        bettingSection.classList.add('hidden');
        resultsSection.classList.add('hidden');
      }
    }

    window.showResults = async function(data) {
      await update(ref(db, `rooms/${window.roomCode}`), { showResults: true });
    };

    window.showResultsManual = async function() {
      await update(ref(db, `rooms/${window.roomCode}`), { showResults: true });
    };

    function showRoundResults(data) {
      const resultsSection = document.getElementById('resultsSection');
      resultsSection.classList.remove('hidden');
      
      document.getElementById('revealedWord').textContent = data.currentWord || '';
      
      const summaryDiv = document.getElementById('roundSummary');
      const submissions = data.submissions || {};
      const bets = data.bets || {};
      
      const submissionBets = {};
      Object.values(bets).forEach(bet => {
        if (!submissionBets[bet.selectedAnswerId]) {
          submissionBets[bet.selectedAnswerId] = [];
        }
        const bettor = data.players.find(p => p.id === bet.playerId);
        if (bettor) submissionBets[bet.selectedAnswerId].push(bettor.name);
      });
      
      let html = '';
      Object.values(submissions).forEach(sub => {
        const betters = submissionBets[sub.playerId] || [];
        const isCorrect = (data.gameMode === 'random_player' || data.gameMode === 'only_1_player') 
          ? sub.playerId === data.excludedPlayer 
          : false;
        
        html += `
          <div class="p-3 rounded-lg border-2 ${isCorrect ? 'border-green-500 bg-green-50' : 'bg-white'}">
            <div class="flex justify-between items-center mb-2">
              <span class="font-semibold">${sub.playerName}'s answer ${isCorrect ? '(Had the word)' : ''}</span>
              ${isCorrect ? '<span class="text-green-600 font-bold">✓</span>' : ''}
            </div>
            ${sub.answerType === 'text' 
              ? `<p class="text-gray-700 mb-2">"${sub.answer}"</p>` 
              : `<img src="${sub.answer}" class="w-full rounded mb-2">`
            }
            ${betters.length > 0 
              ? `<p class="text-sm text-gray-600">Voted by: ${betters.join(', ')}</p>` 
              : `<p class="text-sm text-gray-400">No votes</p>`
            }
          </div>
        `;
      });
      summaryDiv.innerHTML = html;
      
      calculateScoreChanges(data);
      
      const isAdmin = window.currentPlayerId === data.adminId;
      if (isAdmin) {
        document.getElementById('adminResultsControls').classList.remove('hidden');
      } else {
        document.getElementById('adminResultsControls').classList.add('hidden');
      }
    }

    function calculateScoreChanges(data) {
      const scoreChangesDiv = document.getElementById('scoreChangesList');
      const bets = data.bets || {};
      const players = data.players || [];
      
      let wordHolder = null;
      if (data.gameMode === 'random_player' || data.gameMode === 'only_1_player') {
        wordHolder = players.find(p => p.id === data.excludedPlayer);
      }
      
      const scoreChanges = {};
      players.forEach(p => scoreChanges[p.id] = 0);
      
      Object.values(bets).forEach(bet => {
        if (wordHolder && bet.selectedAnswerId === wordHolder.id) {
          scoreChanges[bet.playerId] = (scoreChanges[bet.playerId] || 0) + 1;
        }
      });
      
      if (wordHolder) {
        const correctGuesses = Object.values(bets).filter(b => b.selectedAnswerId === wordHolder.id).length;
        scoreChanges[wordHolder.id] = (scoreChanges[wordHolder.id] || 0) + correctGuesses;
      }
      
      let html = '';
      players.forEach(p => {
        const change = scoreChanges[p.id] || 0;
        if (change !== 0) {
          html += `
            <div class="flex justify-between items-center p-2 rounded" style="background-color: #E8F4D0;">
              <span class="font-medium">${p.name}</span>
              <span class="font-bold text-green-600">+${change} point${change !== 1 ? 's' : ''}</span>
            </div>
          `;
        }
      });
      
      if (html === '') {
        html = '<p class="text-center text-gray-500">No score changes this round</p>';
      }
      
      scoreChangesDiv.innerHTML = html;
      
      window.pendingScoreChanges = scoreChanges;
    }

    window.nextRound = async function() {
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        const players = data.players || [];
        
        const updatedPlayers = players.map(p => ({
          ...p,
          score: (p.score || 0) + (window.pendingScoreChanges[p.id] || 0)
        }));
        
        await update(ref(db, `rooms/${window.roomCode}`), { 
          players: updatedPlayers,
          currentWord: '',
          currentWordType: '',
          submissions: {},
          bets: {},
          bettingMode: false,
          showResults: false,
          excludedPlayer: null,
          readingStarted: false,
          currentDrawingTurn: 0,
          currentStoryTurn: 0,
          canvasData: null,
          storyWords: []
        });
        
        window.pendingScoreChanges = {};
      }, { onlyOnce: true });
    };

    function updateSubmissionStatus(data) {
      if (!data.currentWord) {
        document.getElementById('answerSection').classList.add('hidden');
        return;
      }
      
      document.getElementById('answerSection').classList.remove('hidden');
      
      // Handle collaborative story mode
      if (data.collaborativeStory) {
        document.getElementById('collaborativeStoryDisplay').classList.remove('hidden');
        document.getElementById('collaborativeTurnIndicator').classList.remove('hidden');
        
        const storyWords = data.storyWords || [];
        let storyText = '';
        storyWords.forEach(entry => {
          storyText += entry.words.join(' ') + ' ';
        });
        document.getElementById('storyText').textContent = storyText || 'No words yet. Be the first to contribute!';
        
        const currentTurnIndex = data.currentStoryTurn || 0;
        const currentTurnPlayer = data.players[currentTurnIndex];
        const myTurn = currentTurnPlayer && currentTurnPlayer.id === window.currentPlayerId;
        
        if (myTurn) {
          document.getElementById('turnIndicatorText').textContent = "✍️ It's YOUR turn to add 3 words!";
          document.getElementById('turnIndicatorText').style.color = '#E85987';
          document.getElementById('collaborativeStoryInput').classList.remove('hidden');
          document.getElementById('drawMode').classList.add('hidden');
          document.getElementById('textMode').classList.add('hidden');
          document.getElementById('submitBtn').classList.add('hidden');
        } else {
          document.getElementById('turnIndicatorText').textContent = `⏳ Waiting for ${currentTurnPlayer?.name || 'player'}'s turn...`;
          document.getElementById('turnIndicatorText').style.color = '#6B7280';
          document.getElementById('collaborativeStoryInput').classList.add('hidden');
          document.getElementById('drawMode').classList.add('hidden');
          document.getElementById('textMode').classList.add('hidden');
          document.getElementById('submitBtn').classList.add('hidden');
        }
        
        // Check if all players have contributed
        if (storyWords.length >= data.players.length) {
          document.getElementById('submitBtn').classList.remove('hidden');
          document.getElementById('collaborativeStoryInput').classList.add('hidden');
          document.getElementById('turnIndicatorText').textContent = '✅ Story complete! Submit when ready.';
          document.getElementById('turnIndicatorText').style.color = '#10B981';
        }
      } else {
        document.getElementById('collaborativeStoryDisplay').classList.add('hidden');
        document.getElementById('collaborativeStoryInput').classList.add('hidden');
        document.getElementById('submitBtn').classList.remove('hidden');
        
        // Handle collaborative drawing mode
        if (data.collaborativeDrawing && answerMode === 'draw') {
          document.getElementById('collaborativeTurnIndicator').classList.remove('hidden');
          
          // Load canvas data if it exists
          if (data.canvasData) {
            loadCanvasFromData(data.canvasData);
          }
          
          const currentTurnIndex = data.currentDrawingTurn || 0;
          const currentTurnPlayer = data.players[currentTurnIndex];
          const myTurn = isMyTurn(data);
          
          if (myTurn) {
            document.getElementById('turnIndicatorText').textContent = "🎨 It's YOUR turn to draw!";
            document.getElementById('turnIndicatorText').style.color = '#E85987';
            const playerIndex = data.players.findIndex(p => p.id === window.currentPlayerId);
            if (playerIndex >= 0) {
              currentColor = getPlayerColor(playerIndex);
              document.getElementById('colorPicker').value = currentColor;
              document.getElementById('colorPicker').disabled = true;
            }
          } else {
            document.getElementById('turnIndicatorText').textContent = `⏳ Waiting for ${currentTurnPlayer?.name || 'player'}'s turn...`;
            document.getElementById('turnIndicatorText').style.color = '#6B7280';
          }
          
          canvas.style.cursor = myTurn ? 'crosshair' : 'not-allowed';
          canvas.style.opacity = myTurn ? '1' : '0.6';
        } else {
          document.getElementById('collaborativeTurnIndicator').classList.add('hidden');
          document.getElementById('colorPicker').disabled = false;
          canvas.style.cursor = 'crosshair';
          canvas.style.opacity = '1';
        }
      }
      
      const submissions = data.submissions || {};
      const submittedCount = Object.keys(submissions).length;
      const totalPlayers = data.players ? data.players.length : 0;
      
      document.getElementById('submittedCount').textContent = submittedCount;
      document.getElementById('totalPlayers').textContent = totalPlayers;
      
      if (submissions[window.currentPlayerId]) {
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('submitBtn').textContent = '✓ Submitted';
      } else {
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitBtn').textContent = 'Submit Answer';
      }
      
      const isAdmin = window.currentPlayerId === data.adminId;
      if (isAdmin && submittedCount > 0 && submittedCount === totalPlayers && !data.bettingMode) {
        document.getElementById('placeBetsBtn').classList.remove('hidden');
      } else {
        document.getElementById('placeBetsBtn').classList.add('hidden');
      }
    }

    function displayPlayerCards(data) {
      const container = document.getElementById('playersDisplay');
      if (!data.currentWord || !data.players || data.players.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      const currentPlayer = data.players.find(p => p.id === window.currentPlayerId);
      if (!currentPlayer) {
        container.innerHTML = '';
        return;
      }
      
      const canSee = canPlayerSeeWord(currentPlayer, data);
      const team = currentPlayer.team;
      const borderColor = team === 'A' ? '#5E5394' : team === 'B' ? '#E85987' : '#D1D5DB';
      const showDef = data.showDefinitions && data.showDefinitions[currentPlayer.id];
      
      let defUrl = '#';
      if (data.currentWordType === 'person') {
        defUrl = `https://en.wikipedia.org/wiki/${data.currentWord.replace(/ /g, '_')}`;
      } else if (data.currentWordType === 'fancy') {
        defUrl = `https://www.thesaurus.com/browse/${data.currentWord.toLowerCase()}`;
      } else {
        defUrl = `https://www.dictionary.com/browse/${data.currentWord.toLowerCase()}`;
      }
      
      const cardHtml = `
        <div class="rounded-lg shadow-md p-4 border-2 max-w-md mx-auto" style="background-color: #F5E6D3; border-color: ${borderColor};">
          <h4 class="font-semibold text-lg mb-3">Your Word</h4>
          ${canSee ? `
            <div class="rounded-lg p-4 mb-3" style="background-color: #E8F4D0;">
              <p class="text-xl md:text-2xl font-bold text-center break-words" style="color: #5E5394;">${data.currentWord}</p>
            </div>
            <button onclick="toggleDef(${currentPlayer.id})" class="w-full px-4 py-2 text-white rounded-lg mb-2 text-sm" style="background-color: #E85987;">${showDef ? 'Hide' : 'Show'} Info</button>
            ${showDef ? `<a href="${defUrl}" target="_blank" class="block w-full px-4 py-2 text-center text-white rounded-lg text-sm" style="background-color: #5E5394;">View Definition</a>` : ''}
          ` : `
            <div class="bg-gray-200 rounded-lg p-4 text-center">
              <p class="text-gray-500 font-medium">Word Hidden</p>
              <p class="text-xs text-gray-400 mt-2">You don't see the word this round</p>
            </div>
          `}
        </div>
      `;
      
      container.innerHTML = cardHtml;
    }

    function canPlayerSeeWord(player, data) {
      if (!data.currentWord) return false;
      if (data.gameMode === 'all_see') return true;
      if (data.gameMode === 'team_alternate') {
        if (!player.team) return true;
        const teamASees = data.round % 2 === 1;
        return (player.team === 'A' && teamASees) || (player.team === 'B' && !teamASees);
      }
      if (data.gameMode === 'random_player') {
        return player.id !== data.excludedPlayer;
      }
      if (data.gameMode === 'only_1_player') {
        return player.id === data.excludedPlayer;
      }
      return false;
    }

    window.setTeam = async function(id, team) {
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        const players = data.players.map(p => p.id === id ? { ...p, team } : p);
        await update(ref(db, `rooms/${window.roomCode}`), { players });
      }, { onlyOnce: true });
    };

    window.removePlayer = async function(id) {
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        const players = data.players.filter(p => p.id !== id);
        await update(ref(db, `rooms/${window.roomCode}`), { players });
        
        // Refresh the page for all users if this is the current user
        if (id === window.currentPlayerId) {
          setTimeout(() => location.reload(), 500);
        }
      }, { onlyOnce: true });
    };

    window.randomizeTeams = async function() {
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        if (!data.players || data.players.length < 2) return alert('Need 2+ players');
        
        const shuffled = [...data.players].sort(() => Math.random() - 0.5);
        const mid = Math.ceil(shuffled.length / 2);
        const players = shuffled.map((p, i) => ({ ...p, team: i < mid ? 'A' : 'B' }));
        await update(ref(db, `rooms/${window.roomCode}`), { players });
      }, { onlyOnce: true });
    };

    window.setGameMode = async function(mode) {
      if (window.currentPlayerId !== window.roomAdminId) return;
      await update(ref(db, `rooms/${window.roomCode}`), { gameMode: mode });
    };

    window.toggleCategory = async function(cat) {
      if (window.currentPlayerId !== window.roomAdminId) return;
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        const cats = data.wordCategories || {};
        cats[cat] = !cats[cat];
        await update(ref(db, `rooms/${window.roomCode}`), { wordCategories: cats });
      }, { onlyOnce: true });
    };

    window.generateWord = async function() {
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        let pool = [];
        if (data.wordCategories.nouns) pool.push(...window.WORDS.nouns.map(w => ({ word: w, type: 'noun' })));
        if (data.wordCategories.adjectives) pool.push(...window.WORDS.adjectives.map(w => ({ word: w, type: 'adjective' })));
        if (data.wordCategories.fancyWords) pool.push(...window.WORDS.fancyWords.map(w => ({ word: w, type: 'fancy' })));
        if (data.wordCategories.famousPeople) pool.push(...window.WORDS.famousPeople.map(w => ({ word: w, type: 'person' })));
        
        if (pool.length === 0) return alert('Select a category');
        
        const item = pool[Math.floor(Math.random() * pool.length)];
        const updates = {
          currentWord: item.word,
          currentWordType: item.type,
          round: (data.round || 0) + 1,
          showDefinitions: {},
          submissions: {},
          bettingMode: false,
          bets: {},
          showResults: false,
          currentDrawingTurn: 0,
          currentStoryTurn: 0,
          canvasData: null,
          storyWords: []
        };
        
        if ((data.gameMode === 'random_player' || data.gameMode === 'only_1_player') && data.players && data.players.length > 0) {
          updates.excludedPlayer = data.players[Math.floor(Math.random() * data.players.length)].id;
        }
        
        await update(ref(db, `rooms/${window.roomCode}`), updates);
        clearCanvas();
        document.getElementById('textAnswer').value = '';
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitBtn').textContent = 'Submit Answer';
        
        const defaultTimer = data.defaultTimer || 60;
        const autoStart = data.autoStartTimer !== false;
        autoStartTimer(defaultTimer, autoStart);
      }, { onlyOnce: true });
    };

    window.toggleDef = async function(playerId) {
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        const defs = data.showDefinitions || {};
        defs[playerId] = !defs[playerId];
        await update(ref(db, `rooms/${window.roomCode}`), { showDefinitions: defs });
      }, { onlyOnce: true });
    };

    window.leaveRoom = async function() {
      if (window.currentPlayerId && window.roomCode) {
        onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
          const data = snap.val();
          if (data && data.players) {
            const players = data.players.filter(p => p.id !== window.currentPlayerId);
            await update(ref(db, `rooms/${window.roomCode}`), { players });
          }
        }, { onlyOnce: true });
      }
      
      if (timerInterval) clearInterval(timerInterval);
      window.roomCode = null;
      window.currentPlayerId = null;
      window.currentPlayerName = null;
      document.getElementById('gameRoom').classList.add('hidden');
      document.getElementById('helpModal').classList.add('hidden');
      document.getElementById('landingHelpModal').classList.add('hidden');
      document.getElementById('lobby').classList.remove('hidden');
    };
  </script>
</body>
</html>
