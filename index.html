<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Word Randomizer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .hidden { display: none !important; }
    body { margin: 0; padding: 0; }
    #canvas { 
      touch-action: none; 
      cursor: crosshair;
      border: 2px solid #4E5987;
    }
  </style>
</head>
<body style="background-color: #D4E4DD;" class="min-h-screen p-4 md:p-8">
  <div class="max-w-6xl mx-auto" id="app">
    <h1 class="text-3xl md:text-4xl font-bold text-center mb-2" style="color: #4E5987;">Word Randomizer</h1>
    <p class="text-center text-gray-600 mb-8">For games with friends for fun</p>

    <!-- Lobby -->
    <div id="lobby">
      <div class="grid md:grid-cols-2 gap-6">
        <div class="rounded-lg shadow-md p-4 md:p-6" style="background-color: #F5E6D3;">
          <h2 class="text-xl md:text-2xl font-bold mb-4" style="color: #4E5987;">Create Room</h2>
          <input type="text" id="createPlayerName" placeholder="Your name" class="w-full px-4 py-2 mb-3 border rounded-lg" maxlength="20">
          <input type="password" id="createPassword" placeholder="Set password (min 4 chars)" class="w-full px-4 py-2 mb-4 border rounded-lg" minlength="4">
          <button onclick="createRoom()" class="w-full px-6 py-3 text-white rounded-lg font-semibold hover:opacity-90" style="background-color: #1EA7D8;">Create Room</button>
        </div>
        <div class="rounded-lg shadow-md p-4 md:p-6" style="background-color: #F5E6D3;">
          <h2 class="text-xl md:text-2xl font-bold mb-4" style="color: #4E5987;">Join Room</h2>
          <input type="text" id="joinPlayerName" placeholder="Your name" class="w-full px-4 py-2 mb-3 border rounded-lg" maxlength="20">
          <input type="text" id="joinRoomCode" placeholder="4-digit room code" class="w-full px-4 py-2 mb-3 border rounded-lg" maxlength="4">
          <input type="password" id="joinPassword" placeholder="Room password" class="w-full px-4 py-2 mb-4 border rounded-lg">
          <button onclick="joinRoom()" class="w-full px-6 py-3 text-white rounded-lg font-semibold hover:opacity-90" style="background-color: #E85987;">Join Room</button>
        </div>
      </div>
    </div>

    <!-- Game Room -->
    <div id="gameRoom" class="hidden">
      <div class="rounded-lg shadow-md p-4 md:p-6 mb-6" style="background-color: #F5E6D3;">
        <div class="flex flex-col md:flex-row justify-between md:items-center gap-2">
          <div>
            <h2 class="text-lg md:text-xl font-semibold">Room: <span id="roomCodeDisplay" class="font-bold text-xl md:text-2xl" style="color: #1EA7D8;"></span></h2>
            <p class="text-sm text-gray-600">You are: <span id="currentPlayerName" class="font-semibold" style="color: #E85987;"></span></p>
          </div>
          <button onclick="leaveRoom()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 w-full md:w-auto">Leave</button>
        </div>
      </div>

      <div class="rounded-lg shadow-md p-4 md:p-6 mb-6" style="background-color: #F5E6D3;">
        <h3 class="font-semibold mb-4">Players in Room (<span id="playerCount">0</span>/12)</h3>
        <button onclick="randomizeTeams()" class="w-full px-6 py-2 text-white rounded-lg mb-4" style="background-color: #11462b;">‚ö° Randomize Teams</button>
        <div id="adminScoreControls" class="hidden mb-4 flex gap-2">
          <button onclick="resetScores()" class="flex-1 px-4 py-2 text-white rounded-lg text-sm" style="background-color: #f5767d;">Reset All Scores</button>
        </div>
        <div id="playersList" class="space-y-2"></div>
      </div>

      <div class="rounded-lg shadow-md p-4 md:p-6 mb-6" style="background-color: #F5E6D3;">
        <h3 class="font-semibold mb-2">Game Mode:</h3>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-4">
          <button onclick="setGameMode('all_see')" id="mode_all_see" class="px-4 py-2 rounded-lg text-sm">Everyone Sees</button>
          <button onclick="setGameMode('team_alternate')" id="mode_team_alternate" class="px-4 py-2 rounded-lg text-sm">Team Alternating</button>
          <button onclick="setGameMode('random_player')" id="mode_random_player" class="px-4 py-2 rounded-lg text-sm">Random Excluded</button>
          <button onclick="setGameMode('only_1_player')" id="mode_only_1_player" class="px-4 py-2 rounded-lg text-sm">Only 1 Sees</button>
        </div>
        
        <div id="adminSettings" class="hidden mb-4 p-3 rounded-lg bg-yellow-50 border-2 border-yellow-300">
          <h4 class="font-semibold text-sm mb-2">‚öôÔ∏è Admin Settings</h4>
          <div class="space-y-2">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="forceAnonymous" onclick="toggleAnonymousMode()" class="w-4 h-4">
              <span class="text-sm">Force anonymous submissions</span>
            </label>
            <div class="flex flex-wrap gap-2 items-center">
              <span class="text-sm font-medium">Default timer:</span>
              <button onclick="setDefaultTimer(30)" id="default_timer30" class="px-2 py-1 rounded text-xs bg-gray-200">30s</button>
              <button onclick="setDefaultTimer(60)" id="default_timer60" class="px-2 py-1 rounded text-xs bg-gray-200">60s</button>
              <button onclick="setDefaultTimer(90)" id="default_timer90" class="px-2 py-1 rounded text-xs bg-gray-200">90s</button>
              <button onclick="setDefaultTimer(120)" id="default_timer120" class="px-2 py-1 rounded text-xs bg-gray-200">120s</button>
            </div>
            <div class="flex gap-2 items-center pt-2">
              <button onclick="toggleTimer()" id="timerControlBtn" class="px-4 py-2 rounded text-sm text-white" style="background-color: #1EA7D8;">Start Timer</button>
              <button onclick="placeBets()" id="placeBetsBtn" class="px-4 py-2 rounded text-sm text-white" style="background-color: #E85987;">Place Bets!</button>
            </div>
          </div>
        </div>
        
        <h3 class="font-semibold mb-2">Word Categories:</h3>
        <div class="grid grid-cols-2 gap-2">
          <label class="flex items-center gap-2 cursor-pointer px-3 py-2 rounded-lg text-sm" style="background-color: #1b1531; color: white;">
            <input type="checkbox" id="cat_nouns" checked onclick="toggleCategory('nouns')">
            <span>Nouns</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer px-3 py-2 rounded-lg text-sm" style="background-color: #1b1531; color: white;">
            <input type="checkbox" id="cat_adjectives" checked onclick="toggleCategory('adjectives')">
            <span>Adjectives</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer px-3 py-2 rounded-lg text-sm" style="background-color: #1b1531; color: white;">
            <input type="checkbox" id="cat_fancy" onclick="toggleCategory('fancyWords')">
            <span>Fancy Words</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer px-3 py-2 rounded-lg text-sm" style="background-color: #1b1531; color: white;">
            <input type="checkbox" id="cat_famous" onclick="toggleCategory('famousPeople')">
            <span>Famous People</span>
          </label>
        </div>
      </div>

      <div class="text-center mb-6 rounded-lg shadow-md p-4 md:p-6" style="background-color: #F5E6D3;">
        <button onclick="generateWord()" class="w-full px-6 md:px-8 py-3 md:py-4 text-white rounded-lg text-lg md:text-xl font-semibold" style="background-color: #1EA7D8;">üé≤ Generate Word</button>
      </div>

      <div id="playersDisplay"></div>

      <!-- Answer Submission Area -->
      <div id="answerSection" class="hidden rounded-lg shadow-md p-4 md:p-6 mb-6" style="background-color: #F5E6D3;">
        <h3 class="font-semibold mb-3">Don't have pen and paper? Write or draw your answer here:</h3>
        
        <div class="mb-3 flex flex-wrap gap-2 items-center">
          <button onclick="setAnswerMode('draw')" id="mode_draw" class="px-4 py-2 rounded text-sm" style="background-color: #5E5394; color: white;">üé® Draw</button>
          <button onclick="setAnswerMode('text')" id="mode_text" class="px-4 py-2 rounded text-sm bg-gray-200">‚úèÔ∏è Text</button>
          <span class="text-sm font-medium ml-auto">Timer:</span>
          <div id="timerDisplay" class="text-2xl font-bold" style="color: #E85987;">--</div>
        </div>

        <!-- Drawing Mode -->
        <div id="drawMode">
          <div class="mb-3 flex flex-wrap gap-2">
            <button onclick="setTool('pen')" id="tool_pen" class="px-3 py-1 rounded text-sm" style="background-color: #5E5394; color: white;">‚úèÔ∏è Pen</button>
            <button onclick="setTool('eraser')" id="tool_eraser" class="px-3 py-1 rounded text-sm bg-gray-200">üßπ Eraser</button>
            <button onclick="clearCanvas()" class="px-3 py-1 rounded text-sm bg-gray-200">üóëÔ∏è Clear</button>
            <input type="color" id="colorPicker" value="#000000" class="h-8 w-12 rounded">
            <input type="range" id="brushSize" min="1" max="20" value="3" class="flex-1 min-w-[100px]">
          </div>
          <canvas id="canvas" width="600" height="400" class="w-full bg-white rounded-lg mb-3"></canvas>
        </div>

        <!-- Text Mode -->
        <div id="textMode" class="hidden">
          <textarea id="textAnswer" placeholder="Type your answer here..." class="w-full h-64 p-4 border-2 rounded-lg mb-3 text-lg" style="border-color: #4E5987;"></textarea>
        </div>
        
        <div class="flex gap-2">
          <button onclick="submitAnswer()" id="submitBtn" class="flex-1 px-6 py-3 text-white rounded-lg font-semibold" style="background-color: #E85987;">Submit Answer</button>
          <div id="submissionStatus" class="flex-1 px-6 py-3 bg-gray-100 rounded-lg text-center font-medium text-gray-600">
            Waiting: <span id="submittedCount">0</span>/<span id="totalPlayers">0</span>
          </div>
        </div>
      </div>

      <!-- Answer Display Section -->
      <div id="answersSection" class="hidden rounded-lg shadow-md p-4 md:p-6 mb-6" style="background-color: #F5E6D3;">
        <h3 class="font-semibold mb-3">Submitted Answers</h3>
        
        <div class="mb-4 flex flex-wrap gap-2">
          <span class="text-sm font-medium">Show to:</span>
          <button onclick="setAnswerVisibility('all')" id="vis_all" class="px-3 py-1 rounded text-sm bg-gray-200">All</button>
          <button onclick="setAnswerVisibility('active_team')" id="vis_active" class="px-3 py-1 rounded text-sm bg-gray-200">Active Team</button>
          <button onclick="setAnswerVisibility('waiting_team')" id="vis_waiting" class="px-3 py-1 rounded text-sm bg-gray-200">Waiting Team</button>
          <button onclick="setAnswerVisibility('excluded')" id="vis_excluded" class="px-3 py-1 rounded text-sm bg-gray-200">Excluded Player</button>
          <button onclick="showAnswers()" class="px-4 py-1 rounded text-sm text-white ml-auto" style="background-color: #1EA7D8;">üìñ Read Answers</button>
        </div>

        <div id="answersList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>

      <!-- Betting Section -->
      <div id="bettingSection" class="hidden rounded-lg shadow-md p-4 md:p-6 mb-6" style="background-color: #F5E6D3;">
        <h3 class="font-semibold mb-3">Place Your Bet!</h3>
        <p class="text-sm text-gray-600 mb-4">Navigate through answers and select which one you think matches the word best.</p>
        
        <div class="mb-4 flex justify-between items-center">
          <button onclick="prevAnswer()" class="px-4 py-2 rounded text-white" style="background-color: #5E5394;">‚Üê Previous</button>
          <span class="font-semibold">Answer <span id="currentAnswerIndex">1</span> of <span id="totalAnswers">0</span></span>
          <button onclick="nextAnswer()" class="px-4 py-2 rounded text-white" style="background-color: #5E5394;">Next ‚Üí</button>
        </div>

        <div id="currentAnswerDisplay" class="bg-white rounded-lg p-6 mb-4 min-h-[300px] flex items-center justify-center"></div>

        <button onclick="selectAnswer()" id="selectAnswerBtn" class="w-full px-6 py-3 text-white rounded-lg font-semibold text-lg" style="background-color: #E85987;">This One!</button>
        
        <div id="betStatus" class="hidden mt-4 p-3 bg-green-100 rounded-lg text-center">
          <p class="font-semibold text-green-800">‚úì Bet Placed!</p>
        </div>

        <div id="adminBettingControls" class="hidden mt-4">
          <button onclick="showResultsManual()" class="w-full px-6 py-3 text-white rounded-lg font-semibold" style="background-color: #11462b;">Show Results Now</button>
        </div>
      </div>

      <!-- Round Results Section -->
      <div id="resultsSection" class="hidden rounded-lg shadow-md p-4 md:p-6 mb-6" style="background-color: #F5E6D3;">
        <h3 class="font-semibold text-xl mb-4 text-center" style="color: #4E5987;">Round Results</h3>
        
        <div class="mb-4 p-4 rounded-lg text-center" style="background-color: #E8F4D0;">
          <p class="text-sm text-gray-600 mb-2">The word was:</p>
          <p class="text-3xl font-bold" style="color: #5E5394;"><span id="revealedWord"></span></p>
        </div>

        <div id="roundSummary" class="space-y-3 mb-4"></div>

        <div id="scoreChanges" class="mb-4 p-4 rounded-lg" style="background-color: #fff;">
          <h4 class="font-semibold mb-3 text-center">Score Changes</h4>
          <div id="scoreChangesList" class="space-y-2"></div>
        </div>

        <div id="adminResultsControls" class="hidden flex gap-2">
          <button onclick="nextRound()" class="flex-1 px-6 py-3 text-white rounded-lg font-semibold text-lg" style="background-color: #1EA7D8;">Next Round</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAtcCz7buZmEoLflrxKcf7vFYY3YOG5gdM",
      authDomain: "nounsandfrowns.firebaseapp.com",
      databaseURL: "https://nounsandfrowns-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "nounsandfrowns",
      storageBucket: "nounsandfrowns.firebasestorage.app",
      messagingSenderId: "948424078081",
      appId: "1:948424078081:web:8dcae9f01988fd8a7ca100"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.db = db;
    window.roomCode = null;
    window.currentPlayerId = null;
    window.currentPlayerName = null;
    window.roomAdminId = null;

    // Canvas setup
    let canvas, ctx;
    let drawing = false;
    let currentTool = 'pen';
    let currentColor = '#000000';
    let brushSize = 3;
    let timerInterval = null;
    let selectedTimer = 60;
    let timeRemaining = 0;
    let answerMode = 'draw';
    let timerRunning = false;
    let bettingAnswers = [];
    let currentBettingIndex = 0;
    window.pendingScoreChanges = {};

    window.WORDS = {
      nouns: ['elephant', 'mountain', 'symphony', 'laboratory', 'adventure', 'telescope', 'cathedral', 'volcano', 'library', 'hurricane', 'galaxy', 'fortress', 'ocean', 'pyramid', 'metropolis', 'compass', 'desert', 'waterfall', 'monastery', 'carnival', 'labyrinth', 'meadow', 'archipelago', 'castle', 'valley', 'aurora', 'canyon', 'jungle', 'peninsula', 'sanctuary', 'butterfly', 'dragon', 'unicorn', 'phoenix', 'lighthouse', 'glacier', 'earthquake', 'tornado', 'avalanche', 'eclipse', 'comet', 'nebula', 'asteroid', 'satellite', 'rocket', 'submarine', 'helicopter', 'parachute', 'microscope', 'binoculars'],
      adjectives: ['magnificent', 'peculiar', 'tremendous', 'delicate', 'mysterious', 'brilliant', 'ancient', 'graceful', 'turbulent', 'serene', 'spectacular', 'elegant', 'ferocious', 'luminous', 'tranquil', 'vibrant', 'majestic', 'bizarre', 'harmonious', 'resilient', 'exquisite', 'radiant', 'enigmatic', 'colossal', 'whimsical', 'pristine', 'formidable', 'ethereal', 'splendid', 'dazzling', 'gleaming', 'shimmering', 'sparkling', 'glittering', 'blazing', 'glowing', 'flickering', 'twinkling', 'shining', 'vivid', 'bold', 'striking', 'dramatic', 'intense', 'powerful', 'mighty', 'strong', 'robust', 'sturdy', 'solid'],
      fancyWords: ['obsequious', 'perspicacious', 'recalcitrant', 'ephemeral', 'ubiquitous', 'vociferous', 'pulchritude', 'quintessential', 'serendipity', 'lackadaisical', 'magnanimous', 'nefarious', 'obfuscate', 'perfidious', 'pusillanimous', 'querulous', 'sagacious', 'sanguine', 'taciturn', 'unctuous', 'verbose', 'zealous'],
      famousPeople: ['Marilyn Monroe', 'Albert Einstein', 'Leonardo da Vinci', 'Iron Man', 'Batman', 'Superman', 'Harry Potter', 'Hermione Granger', 'Luke Skywalker', 'Darth Vader', 'Sherlock Holmes', 'James Bond', 'Spider-Man', 'Wonder Woman', 'Captain America', 'Thor', 'Hulk', 'Black Widow', 'Jon Snow', 'Daenerys Targaryen', 'Marie Curie', 'Isaac Newton', 'Stephen Hawking', 'Nikola Tesla', 'Charles Darwin', 'George Washington', 'Abraham Lincoln', 'Nelson Mandela', 'Winston Churchill', 'Martin Luther King Jr.', 'Mahatma Gandhi', 'Rosa Parks', 'Mother Teresa', 'Cleopatra', 'Julius Caesar', 'Napoleon Bonaparte']
    };

    function initCanvas() {
      canvas = document.getElementById('canvas');
      ctx = canvas.getContext('2d');
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);

      canvas.addEventListener('touchstart', handleTouch);
      canvas.addEventListener('touchmove', handleTouch);
      canvas.addEventListener('touchend', stopDrawing);

      document.getElementById('colorPicker').addEventListener('change', (e) => {
        currentColor = e.target.value;
      });

      document.getElementById('brushSize').addEventListener('input', (e) => {
        brushSize = e.target.value;
      });
    }

    function startDrawing(e) {
      drawing = true;
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    function draw(e) {
      if (!drawing) return;
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;
      
      ctx.lineWidth = brushSize;
      ctx.strokeStyle = currentTool === 'eraser' ? '#ffffff' : currentColor;
      ctx.lineTo(x, y);
      ctx.stroke();
    }

    function stopDrawing() {
      drawing = false;
    }

    function handleTouch(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
    }

    window.setTool = function(tool) {
      currentTool = tool;
      document.getElementById('tool_pen').style.backgroundColor = tool === 'pen' ? '#5E5394' : '#E5E7EB';
      document.getElementById('tool_pen').style.color = tool === 'pen' ? '#fff' : '#000';
      document.getElementById('tool_eraser').style.backgroundColor = tool === 'eraser' ? '#5E5394' : '#E5E7EB';
      document.getElementById('tool_eraser').style.color = tool === 'eraser' ? '#fff' : '#000';
    };

    window.clearCanvas = function() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    };

    window.setAnswerMode = function(mode) {
      answerMode = mode;
      document.getElementById('mode_draw').style.backgroundColor = mode === 'draw' ? '#5E5394' : '#E5E7EB';
      document.getElementById('mode_draw').style.color = mode === 'draw' ? '#fff' : '#000';
      document.getElementById('mode_text').style.backgroundColor = mode === 'text' ? '#5E5394' : '#E5E7EB';
      document.getElementById('mode_text').style.color = mode === 'text' ? '#fff' : '#000';
      
      if (mode === 'draw') {
        document.getElementById('drawMode').classList.remove('hidden');
        document.getElementById('textMode').classList.add('hidden');
      } else {
        document.getElementById('drawMode').classList.add('hidden');
        document.getElementById('textMode').classList.remove('hidden');
      }
    };

    window.setTimer = function(seconds) {
      selectedTimer = seconds;
    };

    window.setDefaultTimer = async function(seconds) {
      await update(ref(db, `rooms/${window.roomCode}`), { defaultTimer: seconds });
    };

    window.toggleAnonymousMode = async function() {
      const checked = document.getElementById('forceAnonymous').checked;
      await update(ref(db, `rooms/${window.roomCode}`), { forceAnonymous: checked });
    };

    window.startTimer = function() {
      if (timerInterval) clearInterval(timerInterval);
      timeRemaining = selectedTimer;
      timerRunning = true;
      updateTimerButton();
      document.getElementById('timerDisplay').textContent = timeRemaining + 's';
      
      timerInterval = setInterval(() => {
        timeRemaining--;
        document.getElementById('timerDisplay').textContent = timeRemaining + 's';
        if (timeRemaining <= 0) {
          clearInterval(timerInterval);
          timerRunning = false;
          updateTimerButton();
          document.getElementById('timerDisplay').textContent = 'TIME!';
        }
      }, 1000);
    };

    window.stopTimer = function() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      timerRunning = false;
      updateTimerButton();
    };

    window.toggleTimer = function() {
      if (timerRunning) {
        stopTimer();
      } else {
        startTimer();
      }
    };

    function updateTimerButton() {
      const btn = document.getElementById('timerControlBtn');
      if (btn) {
        btn.textContent = timerRunning ? 'Stop Timer' : 'Start Timer';
        btn.style.backgroundColor = timerRunning ? '#EF4444' : '#1EA7D8';
      }
    }

    window.placeBets = async function() {
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        if (!data.submissions || Object.keys(data.submissions).length === 0) {
          return alert('No answers submitted yet!');
        }
        
        await update(ref(db, `rooms/${window.roomCode}`), { 
          bettingMode: true,
          bets: {},
          showResults: false
        });
        
        // Start 30 second timer for betting
        stopTimer();
        selectedTimer = 30;
        startTimer();
      }, { onlyOnce: true });
    };

    window.prevAnswer = function() {
      if (currentBettingIndex > 0) {
        currentBettingIndex--;
        displayCurrentBettingAnswer();
      }
    };

    window.nextAnswer = function() {
      if (currentBettingIndex < bettingAnswers.length - 1) {
        currentBettingIndex++;
        displayCurrentBettingAnswer();
      }
    };

    window.selectAnswer = async function() {
      if (bettingAnswers.length === 0) return;
      
      const selectedAnswer = bettingAnswers[currentBettingIndex];
      
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        const bets = data.bets || {};
        bets[window.currentPlayerId] = {
          playerId: window.currentPlayerId,
          selectedAnswerId: selectedAnswer.playerId,
          timestamp: Date.now()
        };
        
        await update(ref(db, `rooms/${window.roomCode}`), { bets });
        document.getElementById('betStatus').classList.remove('hidden');
        document.getElementById('selectAnswerBtn').disabled = true;
      }, { onlyOnce: true });
    };

    function displayCurrentBettingAnswer() {
      if (bettingAnswers.length === 0) return;
      
      const answer = bettingAnswers[currentBettingIndex];
      const container = document.getElementById('currentAnswerDisplay');
      
      if (answer.answerType === 'text') {
        container.innerHTML = `<div class="text-2xl font-medium text-center p-4">${answer.answer}</div>`;
      } else {
        container.innerHTML = `<img src="${answer.answer}" class="max-w-full max-h-[400px] rounded">`;
      }
      
      document.getElementById('currentAnswerIndex').textContent = currentBettingIndex + 1;
    }

    window.adjustScore = async function(playerId, amount) {
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        const players = data.players.map(p => {
          if (p.id === playerId) {
            return { ...p, score: (p.score || 0) + amount };
          }
          return p;
        });
        await update(ref(db, `rooms/${window.roomCode}`), { players });
      }, { onlyOnce: true });
    };

    window.resetScores = async function() {
      if (!confirm('Reset all player scores to 0?')) return;
      
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        const players = data.players.map(p => ({ ...p, score: 0 }));
        await update(ref(db, `rooms/${window.roomCode}`), { players });
      }, { onlyOnce: true });
    };

    // Auto-start timer when word is generated
    window.autoStartTimer = function(defaultTime) {
      selectedTimer = defaultTime || 60;
      window.startTimer();
    };

    window.submitAnswer = async function() {
      let answerData;
      let answerType;
      
      if (answerMode === 'draw') {
        answerData = canvas.toDataURL();
        answerType = 'drawing';
      } else {
        answerData = document.getElementById('textAnswer').value.trim();
        if (!answerData) return alert('Please enter your answer');
        answerType = 'text';
      }
      
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        const isAnonymous = data.forceAnonymous || false;
        const submissions = data.submissions || {};
        submissions[window.currentPlayerId] = {
          playerId: window.currentPlayerId,
          playerName: isAnonymous ? 'Anonymous' : window.currentPlayerName,
          answer: answerData,
          answerType: answerType,
          timestamp: Date.now(),
          isAnonymous: isAnonymous
        };
        
        await update(ref(db, `rooms/${window.roomCode}`), { submissions });
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('submitBtn').textContent = '‚úì Submitted';
      }, { onlyOnce: true });
    };

    window.setAnswerVisibility = function(vis) {
      ['all', 'active_team', 'waiting_team', 'excluded'].forEach(v => {
        const btn = document.getElementById(`vis_${v}`);
        btn.style.backgroundColor = v === vis ? '#5E5394' : '#E5E7EB';
        btn.style.color = v === vis ? '#fff' : '#000';
      });
      window.currentAnswerVisibility = vis;
    };

    window.showAnswers = function() {
      onValue(ref(db, `rooms/${window.roomCode}`), (snap) => {
        const data = snap.val();
        if (!data.submissions) return;
        
        const submissions = Object.values(data.submissions);
        const shuffled = submissions.sort(() => Math.random() - 0.5);
        
        let filtered = shuffled;
        const vis = window.currentAnswerVisibility || 'all';
        
        if (vis !== 'all') {
          filtered = shuffled.filter(sub => {
            const player = data.players.find(p => p.id === sub.playerId);
            if (!player) return false;
            
            if (vis === 'excluded') {
              return player.id === data.excludedPlayer;
            } else if (vis === 'active_team') {
              const teamASees = data.round % 2 === 1;
              return (player.team === 'A' && teamASees) || (player.team === 'B' && !teamASees);
            } else if (vis === 'waiting_team') {
              const teamASees = data.round % 2 === 1;
              return (player.team === 'A' && !teamASees) || (player.team === 'B' && teamASees);
            }
            return true;
          });
        }
        
        const container = document.getElementById('answersList');
        container.innerHTML = filtered.map((sub, idx) => {
          const isText = sub.answerType === 'text';
          const content = isText 
            ? `<div class="bg-white rounded p-4 text-center text-xl font-medium break-words answer-content-${idx}">${sub.answer}</div>`
            : `<img src="${sub.answer}" class="w-full rounded answer-content-${idx}">`;
          
          return `
            <div class="bg-white rounded-lg p-3 shadow" id="answer_${idx}">
              <div class="flex justify-end mb-2">
                <button onclick="toggleAnswer(${idx})" class="px-2 py-1 text-xs rounded" style="background-color: #5E5394; color: white;">Hide</button>
              </div>
              ${content}
            </div>
          `;
        }).join('');
      }, { onlyOnce: true });
    };

    window.toggleAnswer = function(idx) {
      const answerDiv = document.getElementById(`answer_${idx}`);
      const content = answerDiv.querySelector(`.answer-content-${idx}`);
      const btn = answerDiv.querySelector('button');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        btn.textContent = 'Hide';
      } else {
        content.style.display = 'none';
        btn.textContent = 'Show';
      }
    };

    window.createRoom = async function() {
      const name = document.getElementById('createPlayerName').value.trim();
      const pwd = document.getElementById('createPassword').value;
      
      if (!name) return alert('Enter your name');
      if (!pwd || pwd.length < 4) return alert('Password must be 4+ chars');
      
      const code = Math.floor(1000 + Math.random() * 9000).toString();
      const playerId = Date.now();
      
      window.currentPlayerId = playerId;
      window.currentPlayerName = name;
      window.roomAdminId = playerId;
      
      await set(ref(db, `rooms/${code}`), {
        password: pwd,
        adminId: playerId,
        players: [{ id: playerId, name, team: null, score: 0 }],
        currentWord: '',
        currentWordType: '',
        gameMode: 'all_see',
        round: 0,
        excludedPlayer: null,
        wordCategories: { nouns: true, adjectives: true, famousPeople: false, fancyWords: false },
        showDefinitions: {},
        submissions: {},
        answerVisibility: 'all',
        forceAnonymous: false,
        defaultTimer: 60,
        bets: {},
        bettingMode: false,
        showResults: false
      });
      
      window.roomCode = code;
      document.getElementById('lobby').classList.add('hidden');
      document.getElementById('gameRoom').classList.remove('hidden');
      document.getElementById('roomCodeDisplay').textContent = code;
      document.getElementById('currentPlayerName').textContent = name;
      initCanvas();
      listenToRoom(code);
    };

    window.joinRoom = async function() {
      const name = document.getElementById('joinPlayerName').value.trim();
      const code = document.getElementById('joinRoomCode').value;
      const pwd = document.getElementById('joinPassword').value;
      
      if (!name) return alert('Enter your name');
      if (!code || !pwd) return alert('Enter code and password');
      
      onValue(ref(db, `rooms/${code}`), async (snap) => {
        const data = snap.val();
        if (!data) return alert('Room not found');
        if (data.password !== pwd) return alert('Wrong password');
        
        const players = data.players || [];
        if (players.length >= 12) return alert('Room full (12 players max)');
        
        const playerId = Date.now();
        window.currentPlayerId = playerId;
        window.currentPlayerName = name;
        window.roomAdminId = data.adminId;
        
        players.push({ id: playerId, name, team: null, score: 0 });
        await update(ref(db, `rooms/${code}`), { players });
        
        window.roomCode = code;
        document.getElementById('lobby').classList.add('hidden');
        document.getElementById('gameRoom').classList.remove('hidden');
        document.getElementById('roomCodeDisplay').textContent = code;
        document.getElementById('currentPlayerName').textContent = name;
        initCanvas();
        listenToRoom(code);
      }, { onlyOnce: true });
    };

    function listenToRoom(code) {
      onValue(ref(db, `rooms/${code}`), (snap) => {
        const data = snap.val();
        if (data) updateUI(data);
      });
    }

    function updateUI(data) {
      document.getElementById('playerCount').textContent = data.players ? data.players.length : 0;
      
      // Show/hide admin settings
      const isAdmin = window.currentPlayerId === data.adminId;
      const adminPanel = document.getElementById('adminSettings');
      if (isAdmin) {
        adminPanel.classList.remove('hidden');
        // Update admin settings
        document.getElementById('forceAnonymous').checked = data.forceAnonymous || false;
        const defaultTimer = data.defaultTimer || 60;
        [30, 60, 90, 120].forEach(s => {
          const btn = document.getElementById(`default_timer${s}`);
          if (btn) {
            btn.style.backgroundColor = s === defaultTimer ? '#5E5394' : '#E5E7EB';
            btn.style.color = s === defaultTimer ? '#fff' : '#000';
          }
        });
      } else {
        adminPanel.classList.add('hidden');
      }
      
      // Set timer based on default
      if (data.defaultTimer) {
        selectedTimer = data.defaultTimer;
      }
      
      const list = document.getElementById('playersList');
      list.innerHTML = '';
      if (data.players && data.players.length > 0) {
        data.players.forEach(p => {
          const div = document.createElement('div');
          const isCurrentPlayer = p.id === window.currentPlayerId;
          const score = p.score || 0;
          div.className = `flex flex-col sm:flex-row items-stretch sm:items-center gap-2 p-2 rounded ${isCurrentPlayer ? 'bg-yellow-100 border-2 border-yellow-400' : 'bg-gray-50'}`;
          div.innerHTML = `
            <span class="flex-1 font-medium text-sm">${p.name}${isCurrentPlayer ? ' (You)' : ''} <span class="ml-2 px-2 py-1 rounded text-xs" style="background-color: #E8F4D0;">Score: ${score}</span></span>
            <div class="flex gap-1">
              <button onclick="setTeam(${p.id}, 'A')" class="flex-1 sm:flex-none px-2 py-1 rounded text-white text-xs" style="background-color: ${p.team === 'A' ? '#5E5394' : '#E5E7EB'}; color: ${p.team === 'A' ? '#fff' : '#000'}">Team A</button>
              <button onclick="setTeam(${p.id}, 'B')" class="flex-1 sm:flex-none px-2 py-1 rounded text-white text-xs" style="background-color: ${p.team === 'B' ? '#E85987' : '#E5E7EB'}; color: ${p.team === 'B' ? '#fff' : '#000'}">Team B</button>
              <button onclick="setTeam(${p.id}, null)" class="flex-1 sm:flex-none px-2 py-1 rounded text-xs ${p.team === null ? 'bg-gray-400 text-white' : 'bg-gray-200'}">None</button>
              <button onclick="removePlayer(${p.id})" class="flex-1 sm:flex-none px-2 py-1 bg-red-500 text-white rounded text-xs">Remove</button>
              ${isAdmin ? `<button onclick="adjustScore(${p.id}, 1)" class="flex-1 sm:flex-none px-2 py-1 bg-green-500 text-white rounded text-xs">+</button>` : ''}
              ${isAdmin ? `<button onclick="adjustScore(${p.id}, -1)" class="flex-1 sm:flex-none px-2 py-1 bg-orange-500 text-white rounded text-xs">-</button>` : ''}
            </div>
          `;
          list.appendChild(div);
        });
      }
      
      // Show/hide admin score controls
      if (isAdmin) {
        document.getElementById('adminScoreControls').classList.remove('hidden');
      } else {
        document.getElementById('adminScoreControls').classList.add('hidden');
      }
      
      ['all_see', 'team_alternate', 'random_player'].forEach(mode => {
        const btn = document.getElementById(`mode_${mode}`);
        if (data.gameMode === mode) {
          btn.style.backgroundColor = '#29522d';
          btn.style.color = '#fff';
        } else {
          btn.style.backgroundColor = '#E8F4D0';
          btn.style.color = '#000';
        }
      });
      
      if (data.wordCategories) {
        document.getElementById('cat_nouns').checked = data.wordCategories.nouns;
        document.getElementById('cat_adjectives').checked = data.wordCategories.adjectives;
        document.getElementById('cat_fancy').checked = data.wordCategories.fancyWords;
        document.getElementById('cat_famous').checked = data.wordCategories.famousPeople;
      }
      
      displayPlayerCards(data);
      updateSubmissionStatus(data);
      updateBettingSection(data);
    }

    function updateBettingSection(data) {
      const bettingSection = document.getElementById('bettingSection');
      const resultsSection = document.getElementById('resultsSection');
      
      if (data.showResults) {
        // Show results instead of betting
        bettingSection.classList.add('hidden');
        showRoundResults(data);
        return;
      }
      
      if (data.bettingMode && data.submissions) {
        bettingSection.classList.remove('hidden');
        resultsSection.classList.add('hidden');
        
        // Prepare answers for betting
        bettingAnswers = Object.values(data.submissions).sort(() => Math.random() - 0.5);
        document.getElementById('totalAnswers').textContent = bettingAnswers.length;
        
        if (bettingAnswers.length > 0) {
          currentBettingIndex = 0;
          displayCurrentBettingAnswer();
        }
        
        // Check if current player has already bet
        if (data.bets && data.bets[window.currentPlayerId]) {
          document.getElementById('betStatus').classList.remove('hidden');
          document.getElementById('selectAnswerBtn').disabled = true;
        } else {
          document.getElementById('betStatus').classList.add('hidden');
          document.getElementById('selectAnswerBtn').disabled = false;
        }
        
        // Show admin controls
        const isAdmin = window.currentPlayerId === data.adminId;
        if (isAdmin) {
          document.getElementById('adminBettingControls').classList.remove('hidden');
        } else {
          document.getElementById('adminBettingControls').classList.add('hidden');
        }
        
        // Check if all players have bet - if so, show results button for admin
        const totalPlayers = data.players ? data.players.length : 0;
        const totalBets = data.bets ? Object.keys(data.bets).length : 0;
        
        if (totalBets === totalPlayers && window.currentPlayerId === data.adminId) {
          // Auto-show results
          setTimeout(() => showResults(data), 1000);
        }
      } else {
        bettingSection.classList.add('hidden');
        resultsSection.classList.add('hidden');
      }
    }

    window.showResults = async function(data) {
      await update(ref(db, `rooms/${window.roomCode}`), { showResults: true });
    };

    window.showResultsManual = async function() {
      await update(ref(db, `rooms/${window.roomCode}`), { showResults: true });
    };

    function showRoundResults(data) {
      const resultsSection = document.getElementById('resultsSection');
      resultsSection.classList.remove('hidden');
      
      // Show the word
      document.getElementById('revealedWord').textContent = data.currentWord || '';
      
      // Build summary of submissions and bets
      const summaryDiv = document.getElementById('roundSummary');
      const submissions = data.submissions || {};
      const bets = data.bets || {};
      
      // Calculate who bet on each submission
      const submissionBets = {};
      Object.values(bets).forEach(bet => {
        if (!submissionBets[bet.selectedAnswerId]) {
          submissionBets[bet.selectedAnswerId] = [];
        }
        const bettor = data.players.find(p => p.id === bet.playerId);
        if (bettor) submissionBets[bet.selectedAnswerId].push(bettor.name);
      });
      
      // Display each submission with who bet on it
      let html = '';
      Object.values(submissions).forEach(sub => {
        const betters = submissionBets[sub.playerId] || [];
        // In modes where one person has the word, their submission is the "correct" one
        const isCorrect = (data.gameMode === 'random_player' || data.gameMode === 'only_1_player') 
          ? sub.playerId === data.excludedPlayer 
          : false; // In all_see mode, there's no single correct answer
        
        html += `
          <div class="p-3 rounded-lg border-2 ${isCorrect ? 'border-green-500 bg-green-50' : 'bg-white'}">
            <div class="flex justify-between items-center mb-2">
              <span class="font-semibold">${sub.playerName}'s answer ${isCorrect ? '(Had the word)' : ''}</span>
              ${isCorrect ? '<span class="text-green-600 font-bold">‚úì</span>' : ''}
            </div>
            ${sub.answerType === 'text' 
              ? `<p class="text-gray-700 mb-2">"${sub.answer}"</p>` 
              : `<img src="${sub.answer}" class="w-full rounded mb-2">`
            }
            ${betters.length > 0 
              ? `<p class="text-sm text-gray-600">Voted by: ${betters.join(', ')}</p>` 
              : `<p class="text-sm text-gray-400">No votes</p>`
            }
          </div>
        `;
      });
      summaryDiv.innerHTML = html;
      
      // Calculate and display score changes
      calculateScoreChanges(data);
      
      // Show next round button for admin
      const isAdmin = window.currentPlayerId === data.adminId;
      if (isAdmin) {
        document.getElementById('adminResultsControls').classList.remove('hidden');
      } else {
        document.getElementById('adminResultsControls').classList.add('hidden');
      }
    }

    function calculateScoreChanges(data) {
      const scoreChangesDiv = document.getElementById('scoreChangesList');
      const submissions = data.submissions || {};
      const bets = data.bets || {};
      const players = data.players || [];
      
      // Find who had the word (excluded player or in only_1_player mode)
      let wordHolder = null;
      if (data.gameMode === 'random_player' || data.gameMode === 'only_1_player') {
        wordHolder = players.find(p => p.id === data.excludedPlayer);
      }
      
      const scoreChanges = {};
      players.forEach(p => scoreChanges[p.id] = 0);
      
      // Points for correct guesses
      Object.values(bets).forEach(bet => {
        if (wordHolder && bet.selectedAnswerId === wordHolder.id) {
          scoreChanges[bet.playerId] = (scoreChanges[bet.playerId] || 0) + 1;
        }
      });
      
      // Points for the word holder if people guessed their answer
      if (wordHolder) {
        const correctGuesses = Object.values(bets).filter(b => b.selectedAnswerId === wordHolder.id).length;
        scoreChanges[wordHolder.id] = (scoreChanges[wordHolder.id] || 0) + correctGuesses;
      }
      
      // Display changes
      let html = '';
      players.forEach(p => {
        const change = scoreChanges[p.id] || 0;
        if (change !== 0) {
          html += `
            <div class="flex justify-between items-center p-2 rounded" style="background-color: #E8F4D0;">
              <span class="font-medium">${p.name}</span>
              <span class="font-bold text-green-600">+${change} point${change !== 1 ? 's' : ''}</span>
            </div>
          `;
        }
      });
      
      if (html === '') {
        html = '<p class="text-center text-gray-500">No score changes this round</p>';
      }
      
      scoreChangesDiv.innerHTML = html;
      
      // Store score changes to apply in next round
      window.pendingScoreChanges = scoreChanges;
    }

    window.nextRound = async function() {
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        const players = data.players || [];
        
        // Apply score changes
        const updatedPlayers = players.map(p => ({
          ...p,
          score: (p.score || 0) + (window.pendingScoreChanges[p.id] || 0)
        }));
        
        // Reset for next round
        await update(ref(db, `rooms/${window.roomCode}`), { 
          players: updatedPlayers,
          currentWord: '',
          currentWordType: '',
          submissions: {},
          bets: {},
          bettingMode: false,
          showResults: false,
          excludedPlayer: null
        });
        
        window.pendingScoreChanges = {};
      }, { onlyOnce: true });
    };

    function updateSubmissionStatus(data) {
      if (!data.currentWord) {
        document.getElementById('answerSection').classList.add('hidden');
        document.getElementById('answersSection').classList.add('hidden');
        return;
      }
      
      document.getElementById('answerSection').classList.remove('hidden');
      
      const submissions = data.submissions || {};
      const submittedCount = Object.keys(submissions).length;
      const totalPlayers = data.players ? data.players.length : 0;
      
      document.getElementById('submittedCount').textContent = submittedCount;
      document.getElementById('totalPlayers').textContent = totalPlayers;
      
      if (submissions[window.currentPlayerId]) {
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('submitBtn').textContent = '‚úì Submitted';
      } else {
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitBtn').textContent = 'Submit Answer';
      }
      
      if (submittedCount > 0 && submittedCount === totalPlayers) {
        document.getElementById('answersSection').classList.remove('hidden');
      }
    }

    function displayPlayerCards(data) {
      const container = document.getElementById('playersDisplay');
      if (!data.currentWord || !data.players || data.players.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      const teamA = data.players.filter(p => p.team === 'A');
      const teamB = data.players.filter(p => p.team === 'B');
      const noTeam = data.players.filter(p => !p.team);
      
      let html = '';
      
      if (noTeam.length > 0) {
        html += '<h3 class="text-lg font-semibold mb-2 text-gray-700">No Team</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">';
        noTeam.forEach(p => html += createPlayerCard(p, data, null));
        html += '</div>';
      }
      
      if (teamA.length > 0) {
        html += '<h3 class="text-lg font-semibold mb-2" style="color: #5E5394;">Team A</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">';
        teamA.forEach(p => html += createPlayerCard(p, data, 'A'));
        html += '</div>';
      }
      
      if (teamB.length > 0) {
        html += '<h3 class="text-lg font-semibold mb-2" style="color: #E85987;">Team B</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">';
        teamB.forEach(p => html += createPlayerCard(p, data, 'B'));
        html += '</div>';
      }
      
      container.innerHTML = html;
    }

    function createPlayerCard(player, data, team) {
      const canSee = canPlayerSeeWord(player, data);
      const borderColor = team === 'A' ? '#5E5394' : team === 'B' ? '#E85987' : '#D1D5DB';
      const showDef = data.showDefinitions && data.showDefinitions[player.id];
      
      let defUrl = '#';
      if (data.currentWordType === 'person') {
        defUrl = `https://en.wikipedia.org/wiki/${data.currentWord.replace(/ /g, '_')}`;
      } else if (data.currentWordType === 'fancy') {
        defUrl = `https://www.thesaurus.com/browse/${data.currentWord.toLowerCase()}`;
      } else {
        defUrl = `https://www.dictionary.com/browse/${data.currentWord.toLowerCase()}`;
      }
      
      return `
        <div class="rounded-lg shadow-md p-4 border-2" style="background-color: #F5E6D3; border-color: ${borderColor};">
          <h4 class="font-semibold text-lg mb-3">${player.name}</h4>
          ${canSee ? `
            <div class="rounded-lg p-4 mb-3" style="background-color: #E8F4D0;">
              <p class="text-xl md:text-2xl font-bold text-center break-words" style="color: #5E5394;">${data.currentWord}</p>
            </div>
            <button onclick="toggleDef(${player.id})" class="w-full px-4 py-2 text-white rounded-lg mb-2 text-sm" style="background-color: #E85987;">${showDef ? 'Hide' : 'Show'} Info</button>
            ${showDef ? `<a href="${defUrl}" target="_blank" class="block w-full px-4 py-2 text-center text-white rounded-lg text-sm" style="background-color: #5E5394;">View Definition</a>` : ''}
          ` : `
            <div class="bg-gray-200 rounded-lg p-4 text-center">
              <p class="text-gray-500 font-medium">Word Hidden</p>
            </div>
          `}
        </div>
      `;
    }

    function canPlayerSeeWord(player, data) {
      if (!data.currentWord) return false;
      if (data.gameMode === 'all_see') return true;
      if (data.gameMode === 'team_alternate') {
        if (!player.team) return true;
        const teamASees = data.round % 2 === 1;
        return (player.team === 'A' && teamASees) || (player.team === 'B' && !teamASees);
      }
      if (data.gameMode === 'random_player') {
        return player.id !== data.excludedPlayer;
      }
      return false;
    }

    window.setTeam = async function(id, team) {
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        const players = data.players.map(p => p.id === id ? { ...p, team } : p);
        await update(ref(db, `rooms/${window.roomCode}`), { players });
      }, { onlyOnce: true });
    };

    window.removePlayer = async function(id) {
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        const players = data.players.filter(p => p.id !== id);
        await update(ref(db, `rooms/${window.roomCode}`), { players });
      }, { onlyOnce: true });
    };

    window.randomizeTeams = async function() {
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        if (!data.players || data.players.length < 2) return alert('Need 2+ players');
        
        const shuffled = [...data.players].sort(() => Math.random() - 0.5);
        const mid = Math.ceil(shuffled.length / 2);
        const players = shuffled.map((p, i) => ({ ...p, team: i < mid ? 'A' : 'B' }));
        await update(ref(db, `rooms/${window.roomCode}`), { players });
      }, { onlyOnce: true });
    };

    window.setGameMode = async function(mode) {
      await update(ref(db, `rooms/${window.roomCode}`), { gameMode: mode });
    };

    window.toggleCategory = async function(cat) {
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        const cats = data.wordCategories || {};
        cats[cat] = !cats[cat];
        await update(ref(db, `rooms/${window.roomCode}`), { wordCategories: cats });
      }, { onlyOnce: true });
    };

    window.generateWord = async function() {
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        let pool = [];
        if (data.wordCategories.nouns) pool.push(...window.WORDS.nouns.map(w => ({ word: w, type: 'noun' })));
        if (data.wordCategories.adjectives) pool.push(...window.WORDS.adjectives.map(w => ({ word: w, type: 'adjective' })));
        if (data.wordCategories.fancyWords) pool.push(...window.WORDS.fancyWords.map(w => ({ word: w, type: 'fancy' })));
        if (data.wordCategories.famousPeople) pool.push(...window.WORDS.famousPeople.map(w => ({ word: w, type: 'person' })));
        
        if (pool.length === 0) return alert('Select a category');
        
        const item = pool[Math.floor(Math.random() * pool.length)];
        const updates = {
          currentWord: item.word,
          currentWordType: item.type,
          round: (data.round || 0) + 1,
          showDefinitions: {},
          submissions: {},
          bettingMode: false,
          bets: {},
          showResults: false
        };
        
        if ((data.gameMode === 'random_player' || data.gameMode === 'only_1_player') && data.players && data.players.length > 0) {
          updates.excludedPlayer = data.players[Math.floor(Math.random() * data.players.length)].id;
        }
        
        await update(ref(db, `rooms/${window.roomCode}`), updates);
        clearCanvas();
        document.getElementById('textAnswer').value = '';
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitBtn').textContent = 'Submit Answer';
        
        // Auto-start timer with default time
        const defaultTimer = data.defaultTimer || 60;
        autoStartTimer(defaultTimer);
      }, { onlyOnce: true });
    };

    window.toggleDef = async function(playerId) {
      onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
        const data = snap.val();
        const defs = data.showDefinitions || {};
        defs[playerId] = !defs[playerId];
        await update(ref(db, `rooms/${window.roomCode}`), { showDefinitions: defs });
      }, { onlyOnce: true });
    };

    window.leaveRoom = async function() {
      if (window.currentPlayerId && window.roomCode) {
        onValue(ref(db, `rooms/${window.roomCode}`), async (snap) => {
          const data = snap.val();
          if (data && data.players) {
            const players = data.players.filter(p => p.id !== window.currentPlayerId);
            await update(ref(db, `rooms/${window.roomCode}`), { players });
          }
        }, { onlyOnce: true });
      }
      
      if (timerInterval) clearInterval(timerInterval);
      window.roomCode = null;
      window.currentPlayerId = null;
      window.currentPlayerName = null;
      document.getElementById('gameRoom').classList.add('hidden');
      document.getElementById('lobby').classList.remove('hidden');
    };
  </script>
</body>
</html>
